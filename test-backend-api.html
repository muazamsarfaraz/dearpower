<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Backend API Integration</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .result {
            background-color: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .error {
            background-color: #ffe6e6;
            color: #d00;
        }
        .success {
            background-color: #e6ffe6;
            color: #060;
        }
        .loading {
            background-color: #fff3cd;
            color: #856404;
        }
        button {
            background-color: #007cba;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #005a87;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .form-group {
            margin: 10px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Test Backend API Integration</h1>
    
    <div class="test-section">
        <h2>Environment Check</h2>
        <p>Check if the backend is properly configured with environment variables:</p>
        <button onclick="checkEnvironment()">Check Environment</button>
        <div id="envResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>API Endpoint Test</h2>
        <p>Test the backend API endpoint with sample data:</p>
        
        <div class="form-group">
            <label for="testMpName">MP Name:</label>
            <input type="text" id="testMpName" value="Valerie Vaz">
        </div>
        
        <div class="form-group">
            <label for="testConstituency">Constituency:</label>
            <input type="text" id="testConstituency" value="Walsall and Bloxwich">
        </div>
        
        <div class="form-group">
            <label for="testTopic">Topic:</label>
            <select id="testTopic">
                <option value="Healthcare">Healthcare</option>
                <option value="Cost of Living">Cost of Living</option>
                <option value="Education">Education</option>
                <option value="Environment">Environment</option>
                <option value="Housing">Housing</option>
                <option value="Other">Other</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="testReference">Reference URL (optional):</label>
            <textarea id="testReference" rows="2" placeholder="https://www.bbc.com/news/health-article-example">https://www.bbc.com/news/health-67890123</textarea>
        </div>
        
        <button onclick="testBackendAPI()" id="testApiBtn">Test Backend API</button>
        <button onclick="testWithoutReference()" id="testNoRefBtn">Test Without Reference</button>
        
        <div id="apiResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>Frontend Integration Test</h2>
        <p>Test the updated frontend OpenAI helper:</p>
        <button onclick="testFrontendIntegration()">Test Frontend Integration</button>
        <div id="frontendResult" class="result"></div>
    </div>

    <script type="module">
        import { OpenAIHelper } from './js/openai.js';

        window.checkEnvironment = async function() {
            const resultDiv = document.getElementById('envResult');
            resultDiv.className = 'result loading';
            resultDiv.textContent = 'Checking environment configuration...';
            
            try {
                // Test a simple API call to see if the server responds
                const response = await fetch('/api/generate-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({}) // Empty body to trigger validation error
                });
                
                const data = await response.json();
                
                if (response.status === 400 && data.error.includes('Missing required fields')) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = '‚úÖ Backend API endpoint is responding correctly\n‚úÖ Server is running with proper configuration\n‚úÖ Environment variables appear to be loaded';
                } else if (response.status === 500 && data.error.includes('OpenAI API key not configured')) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = '‚ùå OpenAI API key is not configured on the server\n‚ùå Check your .env file and restart the server';
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Unexpected response: ${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Error connecting to backend: ${error.message}`;
            }
        };

        window.testBackendAPI = async function() {
            const resultDiv = document.getElementById('apiResult');
            const btn = document.getElementById('testApiBtn');
            
            btn.disabled = true;
            resultDiv.className = 'result loading';
            resultDiv.textContent = 'Testing backend API with OpenAI o1-mini...';
            
            const testData = {
                mp: { name: document.getElementById('testMpName').value },
                topic: document.getElementById('testTopic').value,
                reference: document.getElementById('testReference').value || null,
                constituency: document.getElementById('testConstituency').value
            };
            
            try {
                const response = await fetch('/api/generate-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    let resultText = `‚úÖ Backend API Success!\n\n`;

                    if (data.articleFetched) {
                        resultText += `üì∞ Article Successfully Fetched:\n`;
                        resultText += `Title: ${data.articleTitle}\n`;
                        resultText += `URL: ${data.articleUrl}\n\n`;
                    } else if (data.articleUrl) {
                        resultText += `‚ö†Ô∏è Article could not be fetched from: ${data.articleUrl}\n`;
                        resultText += `Email generated without article content.\n\n`;
                    }

                    resultText += `Generated Email:\n${data.emailContent}`;
                    resultDiv.textContent = resultText;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Backend API Error: ${data.error}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Request failed: ${error.message}`;
            } finally {
                btn.disabled = false;
            }
        };

        window.testWithoutReference = async function() {
            document.getElementById('testReference').value = '';
            await testBackendAPI();
        };

        window.testFrontendIntegration = async function() {
            const resultDiv = document.getElementById('frontendResult');
            resultDiv.className = 'result loading';
            resultDiv.textContent = 'Testing frontend OpenAI helper integration...';
            
            const testData = {
                mp: { name: 'Valerie Vaz' },
                topic: 'Healthcare',
                reference: 'https://example.com/healthcare-article',
                constituency: 'Walsall and Bloxwich'
            };
            
            try {
                const emailContent = await OpenAIHelper.generateEmail(testData);
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `‚úÖ Frontend Integration Success!\n\nGenerated Email:\n${emailContent}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Frontend Integration Error: ${error.message}`;
            }
        };
    </script>
</body>
</html>
