<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Write to Your MP</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#1e40af"> <!-- Use primary color -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <link rel="manifest" id="manifestLink">
  <!-- Mapbox GL JS library -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <!-- Mapbox Address Autofill CSS and JS -->
  <style>
   /* --- Variables --- */
   :root {
     scroll-behavior: smooth;
     --primary-color: #1e40af; /* Indigo 800 */
     --primary-dark: #1a3688; /* Slightly darker indigo */
     --primary-light: #3b82f6; /* Blue 500 */
     --primary-light-alt: #60a5fa; /* Blue 400 for subtle backgrounds */
     --success-color: #10b981; /* Green 500 */
     --danger-color: #ef4444; /* Red 500 */
     --warning-color: #f59e0b; /* Amber 500 */
     --info-color: #0ea5e9; /* Sky 500 */

     --success-bg: rgba(16, 185, 129, 0.15);
     --warning-bg: rgba(245, 158, 11, 0.15);
     --info-bg: rgba(14, 165, 233, 0.15);
     --danger-bg: rgba(239, 68, 68, 0.15);

     --gray-50: #f9fafb;
     --gray-100: #f3f4f6; /* Used for light backgrounds */
     --gray-200: #e5e7eb; /* Used for borders */
     --gray-300: #d1d5db;
     --gray-400: #9ca3af;
     --gray-500: #6b7280; /* Text muted */
     --gray-600: #4b5563;
     --gray-700: #374151; /* Darker text */
     --gray-800: #1f2937;
     --gray-900: #111827; /* Heading text */

     --border-radius-sm: 0.5rem;
     --border-radius: 0.75rem;
     --border-radius-lg: 1rem;
     --border-radius-full: 9999px; /* For badges/pills */

     --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
     --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
     --shadow-md: 0 6px 10px -2px rgba(0, 0, 0, 0.1), 0 3px 6px -2px rgba(0, 0, 0, 0.05);
     --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);

     --transition-base: all 0.2s ease-in-out;
   }

   /* --- General Styles --- */
   body {
     background-color: var(--gray-50); /* Very light background */
     color: var(--gray-800); /* Slightly softer text color */
     font-family: 'Inter', sans-serif; /* Use Inter, fallback to sans-serif */
     line-height: 1.65; /* Slightly increased line height */
     transition: var(--transition-base); /* Smooth transitions for theme changes */
     text-rendering: optimizeLegibility; /* Improve font rendering */
     -webkit-font-smoothing: antialiased; /* Enable font smoothing */
     -moz-osx-font-smoothing: grayscale;
   }

   h1, h2, h3, h4, h5, h6 {
       color: var(--gray-900); /* Darker headings */
       font-weight: 600; /* Semi-bold headings */
   }

   a {
       color: var(--primary-color);
       text-decoration: none;
       transition: color 0.2s ease;
   }

   a:hover {
       color: var(--primary-dark);
       text-decoration: underline;
   }

   /* --- Hero Section --- */
   .hero {
     background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-light) 100%); /* Brighter gradient */
     color: #fff;
     padding: 3rem 0; /* More generous padding */
     box-shadow: var(--shadow-md); /* Slightly stronger shadow */
     margin-bottom: 2rem;
   }

   .hero h1 {
     color: #fff; /* White heading */
     font-weight: 700; /* Bold hero title */
     margin-bottom: 0.5rem;
   }

   .hero .lead {
     color: rgba(255, 255, 255, 0.9); /* Slightly transparent white */
     font-size: 1.1rem;
   }

   .hero .input-group .form-control {
       border: none;
       border-radius: var(--border-radius-sm) 0 0 var(--border-radius-sm);
   }
   .hero .input-group .btn {
       border: none;
       border-radius: 0 var(--border-radius-sm) var(--border-radius-sm) 0;
       background-color: #fff;
       color: var(--gray-700);
       transition: var(--transition-base);
   }
   .hero .input-group .btn:hover {
       background-color: var(--gray-100);
       color: var(--gray-900);
   }

   .hero #constituencyLabel {
       color: rgba(255, 255, 255, 0.9);
       font-size: 0.875rem;
       margin-top: 0.5rem !important;
   }


   /* --- Progress Bar & Steps --- */
   .progress-container {
        display: flex;
        align-items: center;
        margin-bottom: 1.5rem;
   }

   .progress {
     height: 0.6rem; /* Slightly thicker */
     border-radius: var(--border-radius-full); /* Fully rounded */
     background-color: var(--gray-200);
     overflow: hidden;
     flex-grow: 1;
   }

   .progress-bar {
     background-color: var(--primary-color);
     transition: width 0.6s ease;
     border-radius: var(--border-radius-full); /* Ensure bar itself is rounded */
   }

   .progress-steps {
       display: flex;
       justify-content: space-between;
       width: 100%;
       position: relative;
       margin-top: -1.5rem; /* Position above the line */
       z-index: 1;
       pointer-events: none; /* Prevent clicks on steps */
   }

   .progress-step {
     flex: 1;
     text-align: center;
     font-size: 0.875rem;
     position: relative;
     transition: color 0.3s ease, font-weight 0.3s ease;
     color: var(--gray-500); /* Default color */
     font-weight: 500;
   }

   .progress-step::before {
       content: '';
       display: block;
       width: 16px;
       height: 16px;
       background-color: var(--gray-300);
       border-radius: 50%;
       border: 2px solid var(--gray-100);
       position: absolute;
       top: -2.5rem; /* Adjust to align with progress bar */
       left: 50%;
       transform: translateX(-50%);
       transition: var(--transition-base);
       z-index: 2;
   }

    .progress-step.active {
     color: var(--gray-900); /* Darker text for active step */
     font-weight: 600;
    }

   .progress-step.active::before {
       background-color: var(--primary-color);
       border-color: #fff; /* White border on active */
   }

    .progress-step.completed::before {
        background-color: var(--success-color); /* Green for completed steps */
        border-color: #fff;
    }


   /* --- Cards --- */
   .card {
     transition: var(--transition-base);
     border: 1px solid var(--gray-200); /* Subtle border */
     border-radius: var(--border-radius); /* Consistent radius */
     background-color: #fff;
     overflow: hidden;
     box-shadow: var(--shadow); /* Default shadow */
   }

   .card:hover {
     box-shadow: var(--shadow-md); /* Lift slightly on hover */
   }


   /* --- MP Card --- */
   .mp-card {
      box-shadow: var(--shadow-sm); /* Lighter shadow for the side card */
   }
   .mp-card:hover {
     transform: translateY(-3px); /* Less vertical lift */
     box-shadow: var(--shadow) !important; /* Match default shadow on hover */
   }

   .mp-img {
     width: 140px; /* Slightly smaller image */
     height: 140px;
     object-fit: cover;
     border-radius: 50%;
     border: 4px solid #fff; /* Thinner border */
     box-shadow: var(--shadow-sm);
     transition: var(--transition-base);
     margin-bottom: 1.5rem;
   }

   .mp-img:hover {
     transform: scale(1.02); /* Subtle scale */
     box-shadow: var(--shadow-md);
   }

   .mp-card .card-body {
     padding: 2rem 1.5rem 1.5rem;
   }

   .mp-card .card-title {
     font-weight: 700;
     font-size: 1.75rem; /* Slightly smaller title */
     margin-bottom: 0.25rem; /* Reduced margin */
     color: var(--gray-900);
   }

   .mp-card .badge {
       font-size: 0.85rem; /* Slightly smaller badge text */
       padding: 0.35rem 1rem; /* Adjusted padding */
       font-weight: 600;
       border-radius: var(--border-radius-full);
       letter-spacing: 0.3px;
   }


   /* --- Party badges (using updated color palette) --- */
   .party-lab, .party-labour { background-color: #e4003b; color: white; } /* Labour Red */
   .party-con, .party-conservative { background-color: #1a3688; color: white; } /* Conservative Blue (primary dark) */
   .party-libdem, .party-ld { background-color: #f59e0b; color: white; } /* Lib Dem Amber (warning) */
   .party-snp { background-color: #fcd34d; color: var(--gray-900); } /* SNP Yellow (Amber 300) */
   .party-green { background-color: #4ade80; color: var(--gray-900); } /* Green 400 */
   .party-plaidcymru { background-color: #047857; color: white; } /* Emerald 700 */
   .party-dup { background-color: #d946ef; color: white; } /* Purple 500 */
   .party-sf { background-color: #22c55e; color: white; } /* Green 500 */
   .party-alliance { background-color: #facc15; color: var(--gray-900); } /* Yellow 400 */
   .party-sdlp { background-color: #f97316; color: white; } /* Orange 500 */
   .party-pc { background-color: #14b8a6; color: white; } /* Teal 500 */
   .party-speaker { background-color: #6b7280; color: white; } /* Gray 500 */
   .party-other, .party-independent { background-color: var(--gray-400); color: white; } /* Gray 400 */


   /* --- Contact details section --- */
   .contact-details {
     padding: 0;
     border-top: 1px solid var(--gray-200);
     background-color: var(--gray-50);
   }

   .contact-section {
     padding: 1.25rem 1.5rem;
     border-bottom: 1px solid var(--gray-200);
     margin: 0;
   }

   .contact-section:last-child {
     border-bottom: none;
   }

   .contact-item {
     margin-bottom: 0.75rem;
   }

   .contact-item:last-child {
     margin-bottom: 0;
   }

   .icon-text {
     display: flex;
     align-items: center;
     gap: 0.75rem; /* slightly more space between icon and text */
   }

   .icon-text i {
     font-size: 1rem;
     color: var(--gray-700);
   }

   .contact-section h6 {
     font-weight: 600;
     font-size: 0.95rem;
     margin: 0;
     color: var(--gray-900);
   }

   .contact-section h6 i {
     color: var(--primary-color);
     font-size: 1.1rem;
   }

   .contact-section h6 i.fa-map-marker-alt {
     color: var(--success-color);
   }

   .contact-item span,
   .contact-item a {
     font-size: 0.9rem;
     line-height: 1.5;
     display: inline-block;
     word-break: break-word;
     hyphens: auto;
     color: var(--gray-700);
   }

   .contact-item a {
     color: var(--primary-color);
     font-weight: 500;
     text-decoration: none;
   }

   .contact-item a:hover {
     text-decoration: underline;
     color: var(--primary-dark);
   }

   .social-links {
     display: flex;
     flex-wrap: wrap;
     gap: 0.75rem;
     padding: 1.25rem 1.5rem; /* Match section padding */
     background-color: var(--gray-50); /* Keep light background */
   }

   .social-links a {
     flex: 1;
     min-width: calc(50% - 0.375rem); /* Adjusted min-width */
     text-align: center;
     padding: 0.6rem;
     border-radius: var(--border-radius-sm); /* Smaller radius */
     font-size: 0.9rem; /* Smaller font */
     background-color: #fff; /* White background */
     color: var(--gray-700);
     font-weight: 500;
     text-decoration: none;
     transition: var(--transition-base);
     border: 1px solid var(--gray-200);
     display: inline-flex; /* Use flexbox for icon+text centering */
     align-items: center;
     justify-content: center;
   }

   .social-links a:hover {
     transform: translateY(-1px); /* Less vertical lift */
     box-shadow: var(--shadow-sm);
     background-color: var(--gray-100); /* Subtle background change */
     color: var(--gray-900);
   }

   .social-links i {
     margin-right: 0.5rem;
     width: 18px; /* Slightly wider icon space */
     text-align: center;
   }

   /* --- Voting record section --- */
   .voting-record {
     background-color: var(--gray-50); /* Light background */
     border-top: 1px solid var(--gray-200);
     padding: 1.5rem; /* Consistent padding */
   }

   .voting-record h6 {
     color: var(--gray-700);
     font-size: 0.95rem;
     margin-bottom: 1rem;
     font-weight: 600;
   }

   .vote-item {
       margin-bottom: 1rem; /* Added margin between items */
   }
   .vote-item:last-child {
       margin-bottom: 0;
   }

   .vote-label {
       font-size: 0.9rem;
       color: var(--gray-700);
       font-weight: 500;
   }

   .vote-percentage {
       font-size: 0.85rem;
       color: var(--gray-500);
   }

   .vote-bar {
     height: 6px; /* Thinner bar */
     border-radius: var(--border-radius-full);
     margin-top: 4px; /* Space above bar */
     background-color: var(--gray-200);
     overflow: hidden;
   }

   .vote-bar > div { /* Direct children of vote-bar */
       height: 100%;
       transition: width 0.5s ease;
   }

   .vote-for { background-color: var(--success-color); }
   .vote-against { background-color: var(--danger-color); }
   .vote-abstain { background-color: var(--gray-500); } /* Use muted gray */
   .vote-absent { background-color: var(--gray-300); } /* Lighter gray for absent */


   /* --- Writing Tips / Placeholder --- */
   .writing-tips {
     background-color: var(--info-bg); /* Info light background */
     border-radius: var(--border-radius);
     padding: 1.5rem;
     margin-bottom: 2rem;
     border: 1px solid rgba(14, 165, 233, 0.2); /* Info light border */
   }

   .writing-tips h6 {
       color: var(--gray-800);
       font-weight: 600;
       margin-bottom: 1rem;
   }

   .tip-item {
     margin-bottom: 0.8rem; /* Reduced margin */
     display: flex;
     align-items: start;
   }

   .tip-number {
     display: flex;
     justify-content: center;
     align-items: center;
     width: 24px; /* Smaller number circle */
     height: 24px;
     background-color: var(--primary-color);
     color: white;
     border-radius: 50%;
     margin-right: 0.75rem;
     font-size: 0.875rem;
     font-weight: 600;
     flex-shrink: 0;
   }

    .mp-placeholder .blockquote-footer {
        font-size: 0.8rem;
        color: var(--gray-500);
        margin-top: 0.5rem;
    }


   /* --- Form Styles --- */
    #draftForm {
        min-height: 60vh; /* Ensure form takes up reasonable space */
    }

   .form-floating > label {
     padding-left: 1rem;
     color: var(--gray-500); /* Muted label color */
   }

   .form-floating > .form-control,
   .form-floating > .form-select {
     padding: 1rem 1rem 0 1rem; /* Adjusted padding */
     height: calc(3.5rem + 2px); /* Standard Bootstrap height */
   }

    .form-floating > .form-control-plaintext ~ label {
        padding: 1rem 1rem 0 1rem;
    }

   .form-control, .form-select {
     border: 1px solid var(--gray-300);
     border-radius: var(--border-radius-sm);
     padding: 0.75rem 1rem;
     font-size: 1rem;
     transition: var(--transition-base);
   }

   .form-control::placeholder {
       color: var(--gray-400);
       opacity: 1;
   }

   .form-control:focus, .form-select:focus {
     border-color: var(--primary-light);
     box-shadow: 0 0 0 0.25rem rgba(59, 130, 246, 0.25); /* Bootstrap focus ring */
     background-color: #fff;
   }

    textarea.form-control {
        min-height: 120px; /* Give textarea more space by default */
        height: auto !important; /* Override inline style if any */
        padding: 0.75rem 1rem;
    }

    .address-tooltip {
        font-size: 0.85rem;
        font-weight: 500;
        background-color: var(--info-color);
        color: white;
        padding: 0.3rem 0.75rem;
        border-radius: var(--border-radius-full);
        cursor: help;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        transition: var(--transition-base);
    }
    .address-tooltip:hover {
        background-color: var(--info-color); /* Keep background on hover */
        opacity: 0.9;
    }
    .address-tooltip i {
        font-size: 0.9em;
    }


    .topic-badge {
        background-color: var(--gray-100);
        color: var(--gray-700);
        border: 1px solid var(--gray-200);
        padding: 0.4rem 1rem;
        border-radius: var(--border-radius-full);
        font-weight: 500;
        cursor: pointer;
        transition: var(--transition-base);
        font-size: 0.875rem;
        display: inline-block; /* Ensure proper spacing */
    }

    .topic-badge:hover {
        background-color: var(--primary-light-alt); /* Lighter primary */
        color: var(--primary-dark);
        border-color: var(--primary-light);
        transform: translateY(-2px);
        box-shadow: var(--shadow-sm);
    }

   .char-count {
     text-align: right;
     font-size: 0.75rem;
     margin-top: 0.25rem;
     color: var(--gray-500); /* Muted gray */
     position: absolute; /* Position relative to textarea container */
     bottom: 8px;
     right: 16px;
     background-color: #fff; /* Ensure visibility on white background */
     padding-left: 8px;
   }

   .char-count.warning {
     color: var(--danger-color); /* Red for warning */
     font-weight: bold;
   }

   /* --- Buttons --- */
   .btn {
       font-weight: 500;
       transition: var(--transition-base);
       border-radius: var(--border-radius-sm);
   }

   .btn-primary {
     background-color: var(--primary-color);
     border-color: var(--primary-color);
   }

   .btn-primary:hover {
     background-color: var(--primary-dark);
     border-color: var(--primary-dark);
   }

   .btn-light {
     background-color: white;
     border: 1px solid var(--gray-200);
     color: var(--gray-700);
   }

   .btn-light:hover {
     background-color: var(--gray-100);
     color: var(--gray-900);
     border-color: var(--gray-300);
   }

   .btn-outline-secondary {
     border-color: var(--gray-300);
     color: var(--gray-700);
   }

   .btn-outline-secondary:hover {
     background-color: var(--gray-100);
     border-color: var(--gray-300);
     color: var(--gray-900);
   }

   .btn-sm {
       font-size: 0.875rem;
       padding: 0.45rem 0.9rem;
       border-radius: var(--border-radius-sm);
   }

   /* --- Utilities & Helpers --- */
   .shadow-sm { box-shadow: var(--shadow-sm) !important; }
   .shadow { box-shadow: var(--shadow) !important; }
   .shadow-md { box-shadow: var(--shadow-md) !important; }
   .shadow-lg { box-shadow: var(--shadow-lg) !important; }


   /* --- Dark Mode (Contrast) --- */
   body.contrast {
     background: #121212; /* Deep dark background */
     color: #e0e0e0; /* Light gray text */
   }

   body.contrast h1, body.contrast h2, body.contrast h3, body.contrast h4, body.contrast h5, body.contrast h6 {
       color: #ffffff; /* White headings */
   }

    body.contrast a {
        color: #bb86fc; /* Purple for links */
    }
    body.contrast a:hover {
        color: #3700b3; /* Darker purple */
        text-decoration: underline;
    }


   body.contrast .hero {
     background: #1f1f1f; /* Darker hero background */
     color: #e0e0e0;
     box-shadow: 0 4px 6px rgba(255,255,255,0.1);
   }
    body.contrast .hero h1 { color: #ffffff; }
    body.contrast .hero .lead { color: rgba(255, 255, 255, 0.8); }
    body.contrast .hero #constituencyLabel { color: rgba(255, 255, 255, 0.8); }

   body.contrast .card {
     background: #1e1e1e; /* Dark card background */
     color: #e0e0e0;
     border-color: #333;
     box-shadow: 0 2px 4px rgba(255,255,255,0.08);
   }
    body.contrast .card:hover { box-shadow: 0 4px 8px rgba(255,255,255,0.12); }

   body.contrast .mp-card { box-shadow: 0 1px 2px rgba(255,255,255,0.06); }
   body.contrast .mp-card:hover { box-shadow: 0 2px 4px rgba(255,255,255,0.08) !important; }

    body.contrast .mp-img { border-color: #1e1e1e; box-shadow: 0 1px 2px rgba(255,255,255,0.05); }
    body.contrast .mp-img:hover { box-shadow: 0 2px 4px rgba(255,255,255,0.08); }

   body.contrast .party-lab, body.contrast .party-labour { background-color: #cf6679; color: #121212; } /* Light red */
   body.contrast .party-con, body.contrast .party-conservative { background-color: #bb86fc; color: #121212; } /* Light purple */
   body.contrast .party-libdem, body.contrast .party-ld { background-color: #fcc419; color: #121212; } /* Light amber */
   body.contrast .party-snp { background-color: #fff; color: #121212; } /* White */
   body.contrast .party-green { background-color: #66bb6a; color: #121212; } /* Light green */
   body.contrast .party-plaidcymru { background-color: #00c4a9; color: #121212; } /* Light teal */
   body.contrast .party-dup { background-color: #ef99f8; color: #121212; } /* Lighter purple */
   body.contrast .party-sf { background-color: #81c784; color: #121212; } /* Lighter green */
   body.contrast .party-alliance { background-color: #fff176; color: #121212; } /* Lighter yellow */
   body.contrast .party-sdlp { background-color: #ffb74d; color: #121212; } /* Lighter orange */
   body.contrast .party-pc { background-color: #4db6ac; color: #121212; } /* Lighter teal */
   body.contrast .party-speaker { background-color: #9e9e9e; color: #121212; } /* Gray */
   body.contrast .party-other, body.contrast .party-independent { background-color: #b0b0b0; color: #121212; } /* Light gray */


   body.contrast .contact-details { background-color: #2a2a2a; border-color: #444; }
   body.contrast .contact-section { border-color: #444; }
   body.contrast .contact-section h6 { color: #fff; }
   body.contrast .icon-text i { color: #b0b0b0; } /* Lighter gray icons */
   body.contrast .contact-section h6 i { color: #bb86fc; } /* Purple */
   body.contrast .contact-section h6 i.fa-map-marker-alt { color: #03dac6; } /* Teal */
   body.contrast .contact-item span, body.contrast .contact-item a { color: #e0e0e0; }
   body.contrast .contact-item a { color: #bb86fc; } /* Purple links */
   body.contrast .contact-item a:hover { color: #d0bfff; /* Lighter purple */ }

   body.contrast .social-links { background-color: #2a2a2a; }
   body.contrast .social-links a {
        background-color: #3a3a3a;
        color: #e0e0e0;
        border-color: #4a4a4a;
    }
    body.contrast .social-links a:hover {
        background-color: #4a4a4a;
        color: #fff;
        box-shadow: none;
        transform: none;
    }

   body.contrast .voting-record { background-color: #2a2a2a; border-color: #444; }
    body.contrast .voting-record h6 { color: #fff; }
    body.contrast .vote-label { color: #e0e0e0; }
    body.contrast .vote-percentage { color: #b0b0b0; }
    body.contrast .vote-bar { background-color: #4a4a4a; }
    body.contrast .vote-for { background-color: #03dac6; } /* Teal */
    body.contrast .vote-against { background-color: #cf6679; } /* Light red */
    body.contrast .vote-abstain { background-color: #b0b0b0; } /* Gray */
    body.contrast .vote-absent { background-color: #909090; } /* Darker gray */

   body.contrast .writing-tips {
       background-color: rgba(14, 165, 233, 0.2); /* Info bg */
       border-color: rgba(14, 165, 233, 0.3); /* Info border */
       color: #e0e0e0;
   }
    body.contrast .writing-tips h6 { color: #fff; }
    body.contrast .tip-number { background-color: #bb86fc; color: #121212; } /* Purple */

   body.contrast .text-muted { color: #b0b0b0 !important; } /* Ensure muted text is visible */

   body.contrast .form-control,
   body.contrast .form-select {
     background-color: #3a3a3a;
     color: #e0e0e0;
     border-color: #4a4a4a;
   }
   body.contrast .form-control::placeholder { color: #b0b0b0; }
   body.contrast .form-control:focus, body.contrast .form-select:focus {
       border-color: #bb86fc; /* Purple focus */
       box-shadow: 0 0 0 0.25rem rgba(187, 134, 252, 0.25);
       background-color: #3a3a3a;
   }
    body.contrast .form-floating > label { color: #b0b0b0; }
    body.contrast .char-count { color: #b0b0b0; background-color: #3a3a3a; }
    body.contrast .char-count.warning { color: #cf6679; } /* Red warning */

    body.contrast .topic-badge {
        background-color: #3a3a3a;
        color: #e0e0e0;
        border-color: #4a4a4a;
    }
    body.contrast .topic-badge:hover {
        background-color: #4a4a4a;
        color: #fff;
        border-color: #5a5a5a;
        transform: none;
        box-shadow: none;
    }

   body.contrast .btn-primary {
     background-color: #bb86fc;
     border-color: #bb86fc;
     color: #121212; /* Dark text on light button */
   }
   body.contrast .btn-primary:hover {
     background-color: #3700b3;
     border-color: #3700b3;
     color: #fff;
   }

   body.contrast .btn-outline-secondary {
     border-color: #4a4a4a;
     color: #e0e0e0;
   }
   body.contrast .btn-outline-secondary:hover {
     background-color: #3a3a3a;
     border-color: #4a4a4a;
     color: #fff;
   }

   body.contrast .dropdown-menu {
       background-color: #1e1e1e;
       border-color: #4a4a4a;
       box-shadow: 0 4px 8px rgba(255,255,255,0.1);
   }
    body.contrast .dropdown-item { color: #e0e0e0; }
    body.contrast .dropdown-item:hover { background-color: #3a3a3a; color: #fff; }
    body.contrast .dropdown-divider { border-top-color: #4a4a4a; }
    body.contrast .dropdown-item-danger { color: #cf6679; }
    body.contrast .dropdown-item-danger:hover, body.contrast .dropdown-item-danger:focus { background-color: #cf6679; color: #121212; }

   body.contrast footer {
     background-color: #1a1a1a;
     color: #b0b0b0;
   }
    body.contrast footer a { color: #b0b0b0; }
    body.contrast footer a:hover { color: #e0e0e0; }


   /* --- Loading/Toast --- */
   .loading-overlay {
     background-color: rgba(18,18,18,0.7); /* Darker overlay in contrast */
     backdrop-filter: blur(6px); /* Stronger blur */
   }

   .toast {
       background-color: #fff;
       color: var(--gray-900);
       border: 1px solid var(--gray-200);
       box-shadow: var(--shadow);
       border-radius: var(--border-radius-sm);
   }
   .toast-header {
       background-color: var(--gray-100);
       border-bottom-color: var(--gray-200);
       color: var(--gray-900);
       font-weight: 600;
   }

    /* Specific toast types (using Bootstrap's colors) */
    .toast.text-bg-success { background-color: var(--success-color) !important; color: white !important; }
    .toast.text-bg-success .toast-header { background-color: rgba(16, 185, 129, 0.8) !important; color: white !important; border-bottom-color: rgba(16, 185, 129, 0.9) !important;}
     .toast.text-bg-success .btn-close { filter: invert(1) grayscale(100%) brightness(200%); } /* White close button */

    .toast.text-bg-danger { background-color: var(--danger-color) !important; color: white !important;}
    .toast.text-bg-danger .toast-header { background-color: rgba(239, 68, 68, 0.8) !important; color: white !important; border-bottom-color: rgba(239, 68, 68, 0.9) !important;}
     .toast.text-bg-danger .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }

    .toast.text-bg-warning { background-color: var(--warning-color) !important; color: white !important;}
    .toast.text-bg-warning .toast-header { background-color: rgba(245, 158, 11, 0.8) !important; color: white !important; border-bottom-color: rgba(245, 158, 11, 0.9) !important;}
     .toast.text-bg-warning .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }

    .toast.text-bg-info { background-color: var(--info-color) !important; color: white !important;}
    .toast.text-bg-info .toast-header { background-color: rgba(14, 165, 233, 0.8) !important; color: white !important; border-bottom-color: rgba(14, 165, 233, 0.9) !important;}
     .toast.text-bg-info .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }


   body.contrast .toast {
        background-color: #2a2a2a;
        color: #e0e0e0;
        border-color: #4a4a4a;
        box-shadow: 0 4px 8px rgba(255,255,255,0.1);
   }
   body.contrast .toast-header {
        background-color: #3a3a3a;
        border-bottom-color: #4a4a4a;
        color: #fff;
   }

    body.contrast .toast.text-bg-success { background-color: #03dac6 !important; color: #121212 !important; }
    body.contrast .toast.text-bg-success .toast-header { background-color: rgba(3, 218, 198, 0.8) !important; color: #121212 !important; border-bottom-color: rgba(3, 218, 198, 0.9) !important;}

    body.contrast .toast.text-bg-danger { background-color: #cf6679 !important; color: #121212 !important; }
    body.contrast .toast.text-bg-danger .toast-header { background-color: rgba(207, 102, 121, 0.8) !important; color: #121212 !important; border-bottom-color: rgba(207, 102, 121, 0.9) !important;}


   /* --- Modals --- */
    .modal-content {
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
        border: none;
    }
    .modal-header {
        border-bottom: 1px solid var(--gray-200);
    }
    .modal-footer {
        border-top: 1px solid var(--gray-200);
    }

    .modal-header.bg-success {
        background-color: var(--success-color) !important;
    }
    .modal-header.bg-success .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%);
    }

    body.contrast .modal-content {
        background-color: #1e1e1e;
        color: #e0e0e0;
    }
    body.contrast .modal-header, body.contrast .modal-footer {
        border-color: #4a4a4a;
    }
    body.contrast .modal-header.bg-success {
        background-color: #03dac6 !important; /* Teal */
        color: #121212 !important;
    }
     body.contrast .modal-header.bg-success .btn-close {
         filter: none;
     }

    .alert-warning {
        background-color: var(--warning-bg);
        border-color: rgba(245, 158, 11, 0.2);
        color: var(--gray-900);
    }
    body.contrast .alert-warning {
        background-color: rgba(245, 158, 11, 0.2);
        border-color: rgba(245, 158, 11, 0.3);
        color: #fff;
    }


   /* --- Footer --- */
   footer {
     background-color: var(--gray-900); /* Very dark background */
     color: var(--gray-300); /* Light gray text */
     font-size: 0.9rem;
     padding: 2rem 0; /* Reduced padding */
   }
    footer h5 {
        color: #fff; /* White headings */
        font-weight: 600;
        font-size: 1rem; /* Smaller footer headings */
        margin-bottom: 1rem;
    }
    footer a {
        color: var(--gray-400); /* Muted links */
        transition: color 0.2s ease;
        font-size: 0.9rem;
    }
    footer a:hover {
        color: #fff; /* White on hover */
        text-decoration: underline;
    }
    footer ul {
        padding-left: 0;
        list-style: none;
    }
    footer ul li {
        margin-bottom: 0.5rem;
    }

    body.contrast footer {
        background-color: #000; /* Pure black */
        color: #a0a0a0;
    }
    body.contrast footer h5 { color: #fff; }
    body.contrast footer a { color: #a0a0a0; }
    body.contrast footer a:hover { color: #fff; }


   /* --- Responsiveness --- */
   @media (max-width: 768px) {
     .hero {
       padding: 2rem 0;
     }
     .hero h1 {
       font-size: 2rem;
       text-align: center;
     }
     .hero .lead {
       font-size: 1.05rem;
       text-align: center;
     }
     .hero .input-group {
        width: 80%; /* Make input group narrower */
        margin: 1rem auto 0; /* Center input group */
     }
     .hero #constituencyLabel {
         text-align: center;
     }

     .progress-steps {
        margin-top: -1.2rem; /* Adjust positioning */
     }
      .progress-step::before {
          top: -2rem;
      }

     .mp-img {
       width: 120px;
       height: 120px;
       margin-bottom: 1rem;
     }
     .mp-card .card-title {
       font-size: 1.5rem;
     }
     .mp-card .card-body {
         padding: 1.5rem 1rem 1rem; /* Reduced padding */
     }

     .contact-section, .social-links, .voting-record {
        padding: 1rem; /* Reduced padding */
     }
     .social-links a {
       min-width: calc(100% - 0.375rem); /* Full width buttons */
     }

     .writing-tips {
        padding: 1.25rem;
     }

     .form-floating > .form-control,
     .form-floating > .form-select,
     .form-floating > .form-control-plaintext ~ label {
        padding: 0.75rem 0.75rem 0 0.75rem;
     }
      .form-control, .form-select, textarea.form-control {
          padding: 0.6rem 0.75rem;
      }
      textarea.form-control {
          min-height: 100px;
      }
      .char-count {
          right: 12px;
          bottom: 6px;
          font-size: 0.7rem;
      }

     .btn { font-size: 0.9rem; }

     footer {
         padding: 1.5rem 0;
     }
      footer h5 { font-size: 0.9rem; margin-bottom: 0.75rem;}
      footer a, footer ul li { font-size: 0.85rem;}
   }

   @media (min-width: 768px) {
       .hero .input-group {
           width: 350px; /* Fixed width for desktop search */
       }
   }

   /* Apply writing-tips styling to contact details - REMOVED BACKGROUND */
   #mpContactDetails {
       /* Removed background-color, border, padding, margin, border-radius */
       border-top: none; /* Keep this to prevent double border */
   }

   /* Removed overrides for individual section borders/padding */
   /* #mpContactDetails .contact-section { ... } */
   /* #mpContactDetails .contact-section:last-child { ... } */

   /* Keep section header styling adjustments */
   #mpContactDetails .contact-section h6 {
     font-weight: 600;
     font-size: 0.95rem; 
     margin-bottom: 1rem; 
     color: var(--gray-700); 
     display: flex;
     align-items: center;
     padding-left: 0;
   }

   #mpContactDetails .contact-section h6 i {
     margin-right: 12px; 
     font-size: 1.1rem;
     padding: 0;
     text-align: left;
     background-color: transparent;
     border-radius: 0;
     width: auto;
     height: auto;
     font-weight: normal;
     color: var(--primary-color);
   }

   #mpContactDetails .contact-section h6 i.fa-map-marker-alt {
       color: var(--success-color);
   }

   /* Keep Style contact item icons like tip-number */
   #mpContactDetails .contact-item {
     display: flex;
     margin-bottom: 0.75rem;
     align-items: center; 
     padding-left: 0;
   }

   #mpContactDetails .contact-item i {
     display: flex;
     justify-content: center;
     align-items: center;
     width: 28px;
     height: 28px;
     background-color: var(--primary-color);
     color: white;
     border-radius: 50%;
     margin-right: 1rem; 
     font-size: 0.875rem;
     font-weight: 600;
     flex-shrink: 0;
     text-align: center; 
     padding: 0;
     font-family: 'Font Awesome 6 Free'; 
   }

   /* --- Contact details section (original rules - modified/removed above) --- */
   /*
   .contact-details {
     padding: 0;
     border-top: 1px solid var(--gray-200);
     background-color: var(--gray-50); /* Light background for this section */
   /*}
   */

   /* Original .contact-section rules - modified/removed above */
   /*
   .contact-section {
     padding: 1.25rem 1.5rem; /* Consistent padding */
   /*  border-bottom: 1px solid var(--gray-200);
     margin: 0; /* Remove margin */
   /*}
   */

   /* Original .contact-section:last-child rule - modified/removed above */
   /*
   .contact-section:last-child {
     border-bottom: none;
   }
   */

   /* Original .contact-section h6 rule - modified/removed above */
   /*
   .contact-section h6 {
     font-weight: 600;
     font-size: 0.95rem; /* Slightly smaller heading */
   /*  margin-bottom: 1rem; /* Reduced margin */
   /*  color: var(--gray-700); /* Darker gray for sub-headings */
   /*  display: flex;
     align-items: center;
   }
   */

   /* Original .contact-section h6 i rule - modified/removed above */
   /*
   .contact-section h6 i {
     margin-right: 12px; /* Reduced icon margin */
   /*  font-size: 1.1rem;
     color: var(--primary-color); /* Primary color for heading icons */
   /*}
   */

   /* Original .contact-section h6 i.fa-map-marker-alt rule - modified/removed above */
   /*
   .contact-section h6 i.fa-map-marker-alt { /* Specific color for constituency icon */
   /*    color: var(--success-color);
   }
   */

   /* Original .contact-item rule - modified/removed above */
   /*
   .contact-item {
     display: flex;
     margin-bottom: 0.8rem; /* Reduced margin */
   /*  align-items: flex-start;
     padding-left: 0;
   }
   */

   /* Original .contact-item:last-child rule - modified/removed above */
   /*
   .contact-item:last-child {
     margin-bottom: 0;
   }
   */

   /* Original .contact-item i rule - modified/removed above */
   /*
   .contact-item i {
     margin-right: 12px; /* Reduced icon margin */
   /*  text-align: center;
     font-size: 1rem;
     color: var(--gray-500); /* Gray for item icons */
   /*  width: 20px; /* Fixed width for icons */
   /*  flex-shrink: 0;
   }
   */
  </style>
</head>
<body>
<!-- Loading spinner overlay -->
<div id="loadingOverlay" class="loading-overlay d-none">
  <div class="spinner-border text-light loading-spinner" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
</div>

<!-- Notification toast container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3"></div>

<nav class="hero">
 <div class="container d-flex flex-column flex-md-row align-items-center justify-content-between">
    <div class="text-center text-md-start mb-3 mb-md-0">
      <h1 class="fw-bold mb-1">Write to Your MP</h1>
      <p class="lead mb-0">Type your postcode, draft & send – it's that simple.</p>
    </div>
    <div class="mt-md-0 text-center text-md-end">
      <div class="input-group">
        <input id="postcodeInput" class="form-control form-control-lg" placeholder="Your postcode" autocomplete="postal-code" aria-label="Enter your postcode" list="postcodeSuggestions">
        <datalist id="postcodeSuggestions"></datalist>
        <button id="findBtn" class="btn btn-light btn-lg"><i class="fa-solid fa-search me-1"></i>Find MP</button>
      </div>
      <small id="constituencyLabel" class="d-block mt-2 text-white fw-medium"></small>
      <small id="postcodeError" class="d-block mt-1 text-warning fw-medium"></small>
    </div>
 </div>
</nav>

<main class="container my-5"> <!-- Added main tag and more vertical margin -->
  <div class="progress-container mb-4">
    <div class="progress w-100">
      <div id="progressBar" class="progress-bar" style="width:0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" role="progressbar" aria-label="Progress"></div>
    </div>
    <div class="dropdown ms-3"> <!-- Added ms-3 for space -->
      <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="settingsDropdown" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Settings dropdown">
        <i class="fa-solid fa-gear"></i>
      </button>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="settingsDropdown">
        <li><button id="contrastBtn" class="dropdown-item"><i class="fa-solid fa-circle-half-stroke fa-fw me-2"></i>High contrast mode</button></li> <!-- fa-fw for consistent width -->
        <li><button id="fontSizeBtn" class="dropdown-item"><i class="fa-solid fa-text-height fa-fw me-2"></i>Larger text</button></li>
        <li><hr class="dropdown-divider"></li>
        <li><button id="resetBtn" class="dropdown-item dropdown-item-danger"><i class="fa-solid fa-trash fa-fw me-2"></i>Reset form</button></li>
      </ul>
    </div>
  </div>
  <div class="progress-steps mb-5 text-muted"> <!-- Positioning adjustment -->
     <span class="progress-step" data-step="1">Find MP</span>
     <span class="progress-step" data-step="2">Draft Message</span> <!-- Slightly clearer label -->
     <span class="progress-step" data-step="3">Review & Send</span>
  </div>

  <div id="contentArea" class="row gy-5"> <!-- More vertical gutter -->
    <!-- MP card -->
    <div class="col-md-4">
      <div id="mpCard" class="card shadow-sm d-none mp-card">
        <div class="card-body text-center position-relative">
          <div class="dropdown writing-guidelines position-absolute top-0 end-0 m-3"> <!-- Position adjustment -->
            <button class="btn btn-sm btn-link text-muted p-0" type="button" id="guidelineDropdown" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Writing guidelines">
              <i class="fa-solid fa-circle-info fa-lg"></i> <!-- Slightly larger icon -->
            </button>
            <div class="dropdown-menu p-3 dropdown-menu-end" style="width: 300px;">
              <h6 class="mb-2">Writing Guidelines</h6>
              <p class="small mb-2 text-muted">When writing to your MP:</p> <!-- Muted text -->
              <ul class="small mb-0 ps-3 text-muted"> <!-- Muted text -->
                <li>Be polite and respectful</li>
                <li>Stick to one issue per message</li>
                <li>Explain your personal connection</li>
                <li>Be specific about what you want</li>
                <li>Keep it concise (under 2000 characters recommended)</li> <!-- Updated from 500 words -->
              </ul>
            </div>
          </div>
          <img id="mpImg" class="mp-img mb-3" src="https://www.parliament.uk/static-image-placeholder.jpg" alt="Photo of MP Placeholder"> <!-- Default placeholder -->
          <h2 id="mpName" class="card-title mb-2 h5"></h2> <!-- Changed to h5, still visually large -->
          <div class="mb-2"><span id="mpParty" class="badge"></span></div>
          <p id="mpConstituency" class="mb-1 text-muted small"></p> <!-- Constituency added below party -->
          <p id="mpSince" class="mb-3 text-muted small"></p> <!-- Small text -->
          <p id="mpEmail" class="d-none"></p> <!-- Kept hidden, used in JS -->
          <p id="mpPhone" class="d-none"></p> <!-- Kept hidden, used in JS -->
        </div>
        <div id="mpContactDetails" class="contact-details">
             <!-- Contact details will be injected here by JS -->
        </div>
        <div id="votingRecordSection" class="card-body small voting-record d-none"> <!-- Added ID and d-none initially -->
          <h6 class="mb-3 fw-bold"><i class="fa-solid fa-chart-simple me-2 text-primary"></i>Recent Voting Record</h6>
          <div class="vote-item">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <span class="vote-label">NHS Funding</span>
              <small class="vote-percentage">84% For</small>
            </div>
            <div class="vote-bar">
              <div class="vote-for" style="width: 84%"></div>
            </div>
          </div>
          <div class="vote-item">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <span class="vote-label">Climate Bill</span>
              <small class="vote-percentage">72% For</small>
            </div>
            <div class="vote-bar">
              <div class="vote-for" style="width: 72%"></div>
            </div>
          </div>
          <div class="vote-item">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <span class="vote-label">Housing Development</span>
              <small class="vote-percentage">23% For</small>
            </div>
            <div class="vote-bar">
              <div class="vote-for" style="width: 23%"></div>
            </div>
          </div>
           <div class="text-center mt-3">
              <a id="votingLink" class="btn btn-sm btn-outline-secondary" target="_blank" rel="noopener noreferrer">
                <i class="fa-solid fa-chart-simple me-1"></i>Full voting record
              </a>
           </div>
        </div>
         <div id="mpLinksSection" class="card-footer text-center bg-light py-3 d-none"> <!-- Added ID, background, padding, d-none -->
          <div class="d-flex gap-2 justify-content-center">
            <a id="websiteLink" class="btn btn-sm btn-outline-secondary flex-grow-1 flex-md-grow-0" target="_blank" rel="noopener noreferrer"> <!-- Added flex classes -->
              <i class="fa-solid fa-globe me-1"></i>Website
            </a>
             <!-- Social links might be better placed in the contact section injected by JS -->
          </div>
        </div>
      </div>

      <!-- Placeholder before MP lookup -->
      <div id="mpPlaceholder" class="card shadow p-4 mp-placeholder"> <!-- Added mp-placeholder class -->
        <div class="text-center mb-3">
          <i class="fa-solid fa-user-tie fa-4x text-muted mb-3"></i>
          <h5>Find Your MP</h5>
          <p class="text-muted small mb-0">Enter your postcode in the search bar above to find your representative and their contact information.</p>
        </div>
        <hr class="my-4"> <!-- Added separator -->
        <div class="writing-tips mb-0"> <!-- Reduced bottom margin -->
          <h6 class="mb-3"><i class="fa-solid fa-lightbulb me-2 text-info"></i>Why write to your MP?</h6> <!-- Improved heading -->
          <div class="tip-item">
            <span class="tip-number">1</span>
            <span>MPs prioritize messages from their own constituents.</span>
          </div>
          <div class="tip-item">
            <span class="tip-number">2</span>
            <span>Sharing your personal story makes your message more impactful.</span>
          </div>
          <div class="tip-item">
            <span class="tip-number">3</span>
            <span>Be specific about the policy or issue you want them to address.</span>
          </div>
          <div class="tip-item">
            <span class="tip-number">4</span>
            <span>Every message you send is logged and helps demonstrate constituent interest.</span>
          </div>
        </div>
        <div class="text-center small mt-4 border-top pt-4 text-muted"> <!-- Added border and padding -->
          <p class="mb-1">"MPs read all constituent messages and over 80% say these influence their decisions."</p>
          <footer class="blockquote-footer">Parliamentary Digital Service, 2024</footer>
        </div>
      </div>
    </div>

    <!-- Message form -->
    <div class="col-md-8">
      <form id="draftForm" class="card shadow p-4"> <!-- Added shadow class -->
        <h3 class="mb-4">Compose your message</h3> <!-- More margin -->

        <div class="alert alert-warning d-none" id="mpWarning">
          <i class="fa-solid fa-triangle-exclamation me-2"></i>
          Please find your MP by entering your postcode above before composing your message.
        </div>

        <div class="mb-4 pb-2 border-bottom"> <!-- Added bottom border and padding -->
          <div class="d-flex justify-content-between align-items-center mb-3"> <!-- More margin -->
            <h5 class="mb-0">Your Details</h5> <!-- Reduced margin -->
            <span class="badge address-tooltip"
                  data-bs-toggle="tooltip"
                  data-bs-placement="top"
                  title="MPs can only respond to their constituents. Your address verifies you're in their constituency.">
              <i class="fa-solid fa-circle-info me-1"></i>Why needed? <!-- Shorter text -->
            </span>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <div class="form-floating">
                <input id="fullName" class="form-control" placeholder="Full name" autocomplete="name" required>
                <label for="fullName">Full name *</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input id="userEmail" type="email" class="form-control" placeholder="Email" autocomplete="email" required>
                <label for="userEmail">Email *</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <textarea id="userAddress" class="form-control" placeholder="Address" rows="3" autocomplete="street-address" required></textarea>
                <label for="userAddress">Address *</label>
              </div>
              <div class="d-flex justify-content-between align-items-center mt-2">
                <div class="form-text text-muted">Include your full address including postcode</div>
                <button type="button" id="findAddressBtn" class="btn btn-sm btn-outline-secondary">
                  <i class="fa-solid fa-map-marker-alt me-1"></i>Find address from postcode
                </button>
              </div>
              <!-- Address dropdown will appear here when postcode lookup is performed -->
              <div id="addressLookupContainer" class="mt-2 d-none">
                <div id="address-autofill-container" class="mb-3"></div>
                <div id="minimap-container" class="mt-3 mb-3 d-none" style="height: 200px; width: 100%; border-radius: 0.5rem;"></div>
                <div id="addressLookupStatus" class="form-text mt-1"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="mb-4 pb-2"> <!-- Added bottom padding -->
          <h5 class="mb-3">Message Details</h5> <!-- More margin -->
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label text-muted">Topic (Optional)</label> <!-- Muted label -->
              <select id="topicSelect" class="form-select"> <!-- Removed required -->
                <option value="" selected>Choose a topic (Optional)</option> <!-- Updated text -->
                <option value="nhs">NHS & Healthcare</option>
                <option value="education">Education</option>
                <option value="climate">Climate & Environment</option>
                <option value="housing">Housing</option>
                <option value="economy">Economy & Jobs</option>
                <option value="immigration">Immigration & Asylum</option>
                <option value="transport">Transport & Infrastructure</option>
                <option value="benefits">Benefits & Welfare</option>
                <option value="crime">Crime & Policing</option>
                <option value="foreign">Foreign Policy</option>
                <option value="other">Other</option>
              </select>
              <div id="topicBadges" class="d-flex flex-wrap gap-2 mt-3"> <!-- Added ID, more top margin -->
                <span class="topic-badge">NHS Waiting Times</span>
                <span class="topic-badge">School Funding</span>
                <span class="topic-badge">Climate Action</span>
                <span class="topic-badge">Social Housing</span>
                <span class="topic-badge">Rail Services</span>
                <span class="topic-badge">Cost of Living</span>
                 <span class="topic-badge">Local Issues</span> <!-- Added more options -->
                 <span class="topic-badge">Benefit Cuts</span>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <input id="emailSubject" class="form-control" placeholder="Subject" required>
                <label for="emailSubject">Subject *</label>
              </div>
            </div>
            <div class="col-12">
              <label for="emailBody" class="form-label text-muted">Message *</label> <!-- Muted label -->
              <div class="position-relative">
                <textarea id="emailBody" class="form-control" rows="10" required></textarea>
                <div id="charCount" class="char-count">0 / 2000</div> <!-- Added total limit -->
              </div>
              <div class="d-flex justify-content-between align-items-center mt-2"> <!-- Aligned items -->
                <div class="form-text text-muted">Be polite, personal and specific. Max 2000 characters.</div> <!-- Muted text, added limit -->
                <button type="button" id="templateBtn" class="btn btn-sm btn-outline-secondary">
                  <i class="fa-solid fa-wand-magic-sparkles me-1"></i>Use template
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="form-check mb-3">
          <input id="copyMe" type="checkbox" class="form-check-input" checked>
          <label class="form-check-label text-muted" for="copyMe">Send me a copy of this message</label> <!-- Muted text, clearer label -->
        </div>

        <div class="form-check mb-4">
          <input id="privacyConsent" type="checkbox" class="form-check-input" required>
          <label class="form-check-label text-muted" for="privacyConsent"> <!-- Muted text -->
            I confirm that I'm a constituent and agree to the <a href="#" data-bs-toggle="modal" data-bs-target="#privacyModal">privacy policy</a> *
          </label>
        </div>

        <div class="d-grid gap-2 d-md-flex justify-content-md-end"> <!-- Flex buttons on medium screens+ -->
          <button id="previewBtn" type="button" class="btn btn-outline-secondary">
            <i class="fa-solid fa-eye me-1"></i>Preview Message
          </button>
          <button id="sendBtn" type="submit" class="btn btn-primary" disabled>
            <i class="fa-solid fa-paper-plane me-1"></i>Send Message
          </button>
        </div>
      </form>
    </div>
  </div>
</main> <!-- Closing main tag -->

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable"> <!-- Made scrollable -->
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="previewModalLabel">Message Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <strong>To:</strong> <span id="previewTo" class="text-muted"></span>
        </div>
        <div class="mb-3">
          <strong>From:</strong> <span id="previewFrom" class="text-muted"></span>
        </div>
        <div class="mb-3">
          <strong>Subject:</strong> <span id="previewSubject" class="text-muted"></span>
        </div>
        <hr>
        <div id="previewBody" class="mb-3 text-muted"></div> <!-- Muted text -->
        <hr>
        <div id="previewSignature" class="mb-3 text-muted small"></div> <!-- Muted text, smaller -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fa-solid fa-pencil me-1"></i>Edit</button>
        <button type="button" class="btn btn-primary" id="previewSendBtn"><i class="fa-solid fa-paper-plane me-1"></i>Send Message</button>
      </div>
    </div>
  </div>
</div>

<!-- Privacy Policy Modal -->
<div class="modal fade" id="privacyModal" tabindex="-1" aria-labelledby="privacyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="privacyModalLabel">Privacy Policy</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-muted"> <!-- Muted text -->
        <h6>How we use your data</h6>
        <p>Your personal information is only used to:</p>
        <ul>
          <li>Forward your message, full name, email address, and physical address to your MP's office.</li> <!-- More specific -->
          <li>Verify you are a constituent of the MP.</li>
          <li>Send you a copy of your message (if requested).</li>
        </ul>

        <h6>We do not:</h6>
        <ul>
          <li>Store the content of your message or your personal details on our servers permanently.</li> <!-- Clearer -->
          <li>Share your details with any third parties beyond your MP's office for the purpose of this message.</li> <!-- Clearer -->
          <li>Use your information for marketing purposes.</li>
        </ul>

        <p>For more information on how your data is handled, please see our full <a href="#" target="_blank">privacy policy</a>.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">I understand</button>
      </div>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="successModalLabel">Message Sent Successfully</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-4">
          <i class="fa-solid fa-circle-check text-success fa-4x mb-3"></i>
          <h4 class="text-gray-900">Thank you!</h4>
          <p class="text-muted">Your message has been successfully sent to your MP.</p> <!-- Clearer text -->
        </div>

        <div class="alert alert-info text-gray-900" role="alert"> <!-- Added role, text color -->
          <h6><i class="fa-solid fa-info-circle me-2 text-info"></i>What happens next?</h6> <!-- Info icon colored -->
          <p class="mb-0 small text-muted">MPs typically respond within 2-3 weeks. If you requested a copy, you'll receive it shortly via email.</p> <!-- Muted text, added email note -->
        </div>

        <h6 class="mt-4 mb-3 text-gray-900">Would you like to:</h6> <!-- More margin -->
        <div class="d-grid gap-3"> <!-- Increased gap -->
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" id="writeAnotherBtn">
            <i class="fa-solid fa-pen-to-square me-1"></i>Write another message
          </button>
          <button type="button" class="btn btn-outline-primary" id="shareFeedbackBtn">
            <i class="fa-solid fa-comment me-1"></i>Share your feedback
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> <!-- Changed to secondary -->
      </div>
    </div>
  </div>
</div>


<footer>
  <div class="container">
    <div class="row">
      <div class="col-md-6 mb-4 mb-md-0"> <!-- More bottom margin -->
        <h5 class="h6">Write to Your MP</h5>
        <p class="small mb-0 text-gray-400">A Democracy Digital project making it easy for you to contact your elected representatives in the UK Parliament.</p> <!-- More descriptive -->
      </div>
      <div class="col-md-3 mb-4 mb-md-0"> <!-- More bottom margin -->
        <h5 class="h6">Resources</h5>
        <ul class="list-unstyled small">
          <li><a href="#" class="text-gray-400">How it works</a></li>
          <li><a href="#" class="text-gray-400">Effective advocacy</a></li>
          <li><a href="#" class="text-gray-400">FAQs</a></li>
        </ul>
      </div>
      <div class="col-md-3">
        <h5 class="h6">Links</h5>
        <ul class="list-unstyled small">
          <li><a href="#" class="text-gray-400">Privacy Policy</a></li> <!-- Added Privacy Link -->
          <li><a href="#" class="text-gray-400">Contact Us</a></li> <!-- Changed text -->
        </ul>
      </div>
    </div>
    <hr class="my-4 border-gray-700"> <!-- Separator -->
    <div class="text-center small text-gray-500"> <!-- Muted text -->
      © 2024 Democracy Digital. Built with <i class="fa-solid fa-heart text-danger"></i>.
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/js/all.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const apiBase = 'https://members-api.parliament.uk/api';
  const mapboxToken = 'pk.eyJ1IjoibXVhemFtc2FyZmFyYXoiLCJhIjoiY205b2dzdnVlMTVuZDJqczcwbnBseW1tYiJ9.-MvfX63GtzUQceap1g6iJQ';

  // --- DOM Elements ---
  const postcodeInput = document.getElementById('postcodeInput');
  const findBtn = document.getElementById('findBtn');
  const constituencyLabel = document.getElementById('constituencyLabel');
  const mpPlaceholder = document.getElementById('mpPlaceholder');

  // MP Card Elements
  const mpCard = document.getElementById('mpCard');
  const mpImg = document.getElementById('mpImg');
  const mpName = document.getElementById('mpName');
  const mpParty = document.getElementById('mpParty');
  const mpConstituency = document.getElementById('mpConstituency'); // Added element
  const mpSince = document.getElementById('mpSince');
  const mpEmail = document.getElementById('mpEmail'); // Hidden element for data
  const mpPhone = document.getElementById('mpPhone'); // Hidden element for data
  const mpContactDetails = document.getElementById('mpContactDetails');
  const votingRecordSection = document.getElementById('votingRecordSection'); // Added
  const mpLinksSection = document.getElementById('mpLinksSection'); // Added
  const votingLink = document.getElementById('votingLink');
  const websiteLink = document.getElementById('websiteLink');

  // Form Elements
  const draftForm = document.getElementById('draftForm');
  const mpWarning = document.getElementById('mpWarning');
  const fullNameInput = document.getElementById('fullName');
  const userEmailInput = document.getElementById('userEmail');
  const userAddressInput = document.getElementById('userAddress');
  const topicSelect = document.getElementById('topicSelect');
  const topicBadges = document.getElementById('topicBadges'); // Added
  const emailSubjectInput = document.getElementById('emailSubject');
  const emailBodyTextarea = document.getElementById('emailBody');
  const charCountSpan = document.getElementById('charCount');
  const templateBtn = document.getElementById('templateBtn');
  const copyMeCheckbox = document.getElementById('copyMe');
  const privacyConsentCheckbox = document.getElementById('privacyConsent');
  const previewBtn = document.getElementById('previewBtn');
  const sendBtn = document.getElementById('sendBtn');

  // Progress Bar Elements
  const progressBar = document.getElementById('progressBar');
  const progressSteps = document.querySelectorAll('.progress-step');

  // Modal Elements
  const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
  const previewToSpan = document.getElementById('previewTo');
  const previewFromSpan = document.getElementById('previewFrom');
  const previewSubjectSpan = document.getElementById('previewSubject');
  const previewBodyDiv = document.getElementById('previewBody');
  const previewSignatureDiv = document.getElementById('previewSignature');
  const previewSendBtn = document.getElementById('previewSendBtn');

  const privacyModal = new bootstrap.Modal(document.getElementById('privacyModal')); // Initialized modal
  const successModal = new bootstrap.Modal(document.getElementById('successModal')); // Initialized modal
  const writeAnotherBtn = document.getElementById('writeAnotherBtn'); // Added
  const shareFeedbackBtn = document.getElementById('shareFeedbackBtn'); // Added

  // Settings Dropdown Elements
  const contrastBtn = document.getElementById('contrastBtn');
  const fontSizeBtn = document.getElementById('fontSizeBtn');
  const resetBtn = document.getElementById('resetBtn');

  // Other Elements
  const loadingOverlay = document.getElementById('loadingOverlay');
  const toastContainer = document.querySelector('.toast-container');
  const addressTooltipTrigger = document.querySelector('.address-tooltip'); // Added tooltip trigger

  // --- State Variables ---
  let currentMP = null;
  let currentStep = 1;
  const maxCharCount = 2000; // Defined max characters

  // Add after the declaration of other DOM elements in the JavaScript section
  const postcodeSuggestions = document.getElementById('postcodeSuggestions');
  const postcodeError = document.getElementById('postcodeError');
  const addressLookupContainer = document.getElementById('addressLookupContainer');
  const addressAutofillContainer = document.getElementById('address-autofill-container');
  const minimapContainer = document.getElementById('minimap-container');
  const addressLookupStatus = document.getElementById('addressLookupStatus');
  const findAddressBtn = document.getElementById('findAddressBtn');

  // --- Helper Functions ---

  // Show/Hide Loading
  function showLoadingOverlay() { loadingOverlay.classList.remove('d-none'); }
  function hideLoadingOverlay() { loadingOverlay.classList.add('d-none'); }

  // Show Toast Notifications
  function showToast(message, type = 'info') {
      const toastHtml = `
          <div class="toast align-items-center text-bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
              <div class="d-flex">
                  <div class="toast-body">
                      ${message}
                  </div>
                  <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
              </div>
          </div>
      `;
      const toastElement = document.createElement('div');
      toastElement.innerHTML = toastHtml;
      toastContainer.appendChild(toastElement.firstElementChild);
      const toast = new bootstrap.Toast(toastContainer.lastElementChild);
      toast.show();
  }

  // Update Progress Bar and Steps
  function updateProgress(step) {
      currentStep = step;
      const progress = (step - 1) * 50; // 0% for step 1, 50% for step 2, 100% for step 3
      if (progressBar) {
        progressBar.style.width = `${progress}%`;
        progressBar.setAttribute('aria-valuenow', progress);
      }

      progressSteps.forEach(stepEl => {
          const stepNumber = parseInt(stepEl.dataset.step);
          stepEl.classList.remove('active', 'completed');
          if (stepNumber === step) {
              stepEl.classList.add('active');
          } else if (stepNumber < step) {
              stepEl.classList.add('completed');
          }
      });
  }

    // Update Send Button State
    function updateSendButtonState() {
        const isFormValid = draftForm.checkValidity();
        sendBtn.disabled = !currentMP || !isFormValid;
        previewBtn.disabled = !currentMP || !isFormValid; // Also disable preview if form invalid
    }

  // Reset Form and MP State
  function resetForm() {
    draftForm.reset();
    showMPCard(false);
    currentMP = null;
    constituencyLabel.textContent = '';
    postcodeInput.value = '';
    mpContactDetails.innerHTML = '';
    if (votingRecordSection) votingRecordSection.classList.add('d-none');
    if (mpLinksSection) mpLinksSection.classList.add('d-none');
    updateProgress(1);
    updateSendButtonState();
    updateCharCount(); // Reset character count
    if (mpWarning) mpWarning.classList.remove('d-none'); // Show warning again
    document.body.classList.remove('larger-text'); // Reset font size if toggled
  }

  // Show/Hide MP Card & Placeholder
  function showMPCard(show) {
    if (mpCard) mpCard.classList.toggle('d-none', !show);
    if (mpPlaceholder) mpPlaceholder.classList.toggle('d-none', show);
    if (mpWarning) mpWarning.classList.toggle('d-none', show); // Hide warning when MP card is shown
    updateSendButtonState(); // Update button state when MP card visibility changes
  }

  // Handle MP Lookup
  async function findMP(postcode) {
    if (!postcode || !postcode.trim()) {
      constituencyLabel.textContent = 'Please enter a postcode.';
      showMPCard(false); // Ensure placeholder is shown
      return;
    }

    showLoadingOverlay();
    constituencyLabel.textContent = 'Looking up MP...';
    showMPCard(false); // Hide existing card and show placeholder immediately

    try {
      // 1. Find Constituency and Member ID
      const searchRes = await fetch(`${apiBase}/Members/Search?Location=${encodeURIComponent(postcode)}&House=1&IsEligible=true&IsCurrentMember=true&skip=0&take=1`);
      if (!searchRes.ok) { // Check for HTTP errors
           throw new Error(`HTTP error! status: ${searchRes.status}`);
      }
      const searchData = await searchRes.json();

      if (!searchData || !searchData.items || !searchData.items.length) {
        constituencyLabel.textContent = `No current MP found for postcode: ${postcode.trim().toUpperCase()}. Please double-check.`;
        hideLoadingOverlay();
        showToast(`No MP found for ${postcode.trim().toUpperCase()}. Please check the postcode.`, 'warning');
        return;
      }
      const mp = searchData.items[0].value;
      currentMP = mp; // Store current MP data

      // 2. Fetch Contact Info
      const contactRes = await fetch(`${apiBase}/Members/${mp.id}/Contact`);
       if (!contactRes.ok) {
           throw new Error(`HTTP error fetching contact info! status: ${contactRes.status}`);
       }
      const contactData = await contactRes.json();
      const contacts = Array.isArray(contactData.value) ? contactData.value : [];
      console.log('MP Contact Info:', contacts);


      // 3. Display MP Info & Contacts
      if (mpName) mpName.textContent = mp.nameDisplayAs || 'Your MP';

      if (mpParty) {
        mpParty.textContent = mp.latestParty?.name || 'Unknown Party';
        const partyClass = mp.latestParty?.abbreviation ? 'party-' + mp.latestParty.abbreviation.toLowerCase() : 'party-other';
        mpParty.className = `badge mb-2 ${partyClass}`; // Update class
      }

      if (mpConstituency && mp.latestHouseMembership?.membershipFrom) {
        mpConstituency.textContent = mp.latestHouseMembership.membershipFrom;
        constituencyLabel.textContent = `Constituency: ${mp.latestHouseMembership.membershipFrom}`; // Display constituency in header
      } else if (mpConstituency) {
         mpConstituency.textContent = '';
         constituencyLabel.textContent = ''; // Clear header label if no constituency found
      }

      if (mpSince && mp.latestHouseMembership?.membershipStartDate) {
        mpSince.textContent = `MP since ${mp.latestHouseMembership.membershipStartDate.slice(0,4)}`;
      } else if (mpSince) {
        mpSince.textContent = '';
      }

      if (mpImg) {
        mpImg.src = mp.thumbnailUrl || 'https://www.parliament.uk/static-image-placeholder.jpg';
        mpImg.alt = `Photo of ${mp.nameDisplayAs || 'MP'}`;
      }

      // Build Contact Details HTML dynamically
      let contactHtml = '';
      constituencyLabel.textContent += ` (${mp.nameDisplayAs || 'Your MP'})`; // Add MP name to header label

      // Filter and group contacts by type
      const parliamentaryOffice = contacts.find(c => c.type === 'Parliamentary office');
      const constituencyOffice = contacts.find(c => c.type === 'Constituency office');
      const webContacts = contacts.filter(c => ['Website', 'X (formerly Twitter)', 'Facebook', 'Instagram'].includes(c.type));

      // Add Parliamentary Office
      if (parliamentaryOffice && (parliamentaryOffice.line1 || parliamentaryOffice.phone || parliamentaryOffice.email)) {
         contactHtml += `<div class="contact-section">
             <div class="contact-item">
               <div class="icon-text">
                 <i class="fa-solid fa-building text-primary"></i>
                 <h6>Parliamentary Office</h6>
               </div>
             </div>`;
         if (parliamentaryOffice.line1) contactHtml += `<div class="contact-item">
             <div class="icon-text">
               <i class="fa-solid fa-location-dot"></i>
               <span>${[parliamentaryOffice.line1, parliamentaryOffice.line2, parliamentaryOffice.line3, parliamentaryOffice.line4, parliamentaryOffice.line5, parliamentaryOffice.postcode].filter(Boolean).join(', ')}</span>
             </div>
           </div>`;
         if (parliamentaryOffice.phone) contactHtml += `<div class="contact-item">
             <div class="icon-text">
               <i class="fa-solid fa-phone"></i>
               <a href="tel:${parliamentaryOffice.phone.replace(/\s/g,'')}">${parliamentaryOffice.phone}</a>
             </div>
           </div>`;
         if (parliamentaryOffice.email) {
             mpEmail.textContent = parliamentaryOffice.email; // Store email for mailto later
             contactHtml += `<div class="contact-item">
               <div class="icon-text">
                 <i class="fa-solid fa-envelope"></i>
                 <a href="mailto:${parliamentaryOffice.email}">${parliamentaryOffice.email}</a>
               </div>
             </div>`;
         }
         contactHtml += `</div>`;
      } else {
          // Fallback if no specific office listed but a general MP email is available
           const generalEmail = contacts.find(c => c.type === 'Email')?.line1;
           if(generalEmail) {
                mpEmail.textContent = generalEmail; // Store general email
                contactHtml += `<div class="contact-section">
                    <div class="contact-item">
                      <div class="icon-text">
                        <i class="fa-solid fa-envelope text-primary"></i>
                        <h6>Primary Contact Email</h6>
                      </div>
                    </div>
                    <div class="contact-item">
                      <div class="icon-text">
                        <i class="fa-solid fa-envelope"></i>
                        <a href="mailto:${generalEmail}">${generalEmail}</a>
                      </div>
                    </div>
                    </div>`;
           }
      }

      // Add Constituency Office
      if (constituencyOffice && (constituencyOffice.line1 || constituencyOffice.phone || constituencyOffice.email)) {
         contactHtml += `<div class="contact-section">
             <div class="contact-item">
               <div class="icon-text">
                 <i class="fa-solid fa-map-marker-alt text-success"></i>
                 <h6>Constituency Office</h6>
               </div>
             </div>`;
         if (constituencyOffice.line1) contactHtml += `<div class="contact-item">
             <div class="icon-text">
               <i class="fa-solid fa-location-dot"></i>
               <span>${[constituencyOffice.line1, constituencyOffice.line2, constituencyOffice.line3, constituencyOffice.line4, constituencyOffice.line5, constituencyOffice.postcode].filter(Boolean).join(', ')}</span>
             </div>
           </div>`;
         if (constituencyOffice.phone) contactHtml += `<div class="contact-item">
             <div class="icon-text">
               <i class="fa-solid fa-phone"></i>
               <a href="tel:${constituencyOffice.phone.replace(/\s/g,'')}">${constituencyOffice.phone}</a>
             </div>
           </div>`;
         if (constituencyOffice.email) contactHtml += `<div class="contact-item">
             <div class="icon-text">
               <i class="fa-solid fa-envelope"></i>
               <a href="mailto:${constituencyOffice.email}">${constituencyOffice.email}</a>
             </div>
           </div>`;
         contactHtml += `</div>`;
      }

      // Add Social/Web Links section if any exist
      if (webContacts.length > 0) {
          let socialHtml = `<div class="social-links">`;
          webContacts.forEach(contact => {
              let icon = 'fa-globe'; // Default icon
              let text = contact.type;
              if (contact.type === 'X (formerly Twitter)') { icon = 'fa-x-twitter'; text = 'Twitter/X'; }
              else if (contact.type === 'Facebook') { icon = 'fa-facebook-f'; } // Using -f for solid icon
              else if (contact.type === 'Instagram') { icon = 'fa-instagram'; }

              // Ensure URL has a protocol
              let url = contact.line1;
               if (url && !/^[a-zA-Z]+:\/\//i.test(url)) {
                   url = 'http://' + url;
               }

              if (url) {
                 socialHtml += `<a href="${url}" target="_blank" rel="noopener noreferrer"><i class="fab ${icon}"></i>${text}</a>`;
              }
          });
          socialHtml += `</div>`;
          contactHtml += socialHtml;
      }

      mpContactDetails.innerHTML = contactHtml;

      // Show voting record & links section (if they have data, currently static)
      if (votingRecordSection) votingRecordSection.classList.remove('d-none');
      if (mpLinksSection) mpLinksSection.classList.remove('d-none');


      if (votingLink && mp.id) {
        votingLink.href = `https://members.parliament.uk/member/${mp.id}/voting`;
      }

      // Set main website link (prefer explicit 'Website' type, otherwise parliament profile)
      const website = contacts.find(c => c.type === 'Website')?.line1;
      if (websiteLink) {
           // Ensure URL has a protocol
           let websiteUrl = website;
            if (websiteUrl && !/^[a-zA-Z]+:\/\//i.test(websiteUrl)) {
                websiteUrl = 'http://' + websiteUrl;
            }
           websiteLink.href = websiteUrl || (mp.id ? `https://members.parliament.uk/member/${mp.id}` : '#');
           websiteLink.classList.toggle('d-none', !websiteUrl && !mp.id); // Hide if no link available
      }


      showMPCard(true); // Show the populated card
      hideLoadingOverlay();
      updateProgress(2); // Move to Draft step
      showToast(`MP found: ${mp.nameDisplayAs || 'Your MP'}`, 'success');

    } catch (e) {
      console.error('Error finding MP:', e);
      constituencyLabel.textContent = `Error: Could not find MP for postcode. Please try again.`;
      hideLoadingOverlay();
      showMPCard(false); // Ensure placeholder is shown on error
      showToast('Error finding MP. Please try again.', 'danger');
    }
  }

  // Character Count for Textarea
  if (emailBodyTextarea) {
    emailBodyTextarea.addEventListener('input', updateCharCount);
    updateCharCount(); // Initial count
  }

  function updateCharCount() {
    if (!emailBodyTextarea || !charCountSpan) return;
    const count = emailBodyTextarea.value.length;
    charCountSpan.textContent = `${count} / ${maxCharCount}`;
    if (count > maxCharCount) {
      charCountSpan.classList.add('warning');
      emailBodyTextarea.classList.add('is-invalid'); // Optional: Add invalid state
    } else {
      charCountSpan.classList.remove('warning');
      emailBodyTextarea.classList.remove('is-invalid');
    }
    updateSendButtonState(); // Update state whenever text changes
  }

  // Topic Badge Click
    if(topicBadges) {
        topicBadges.addEventListener('click', (e) => {
            if (e.target.classList.contains('topic-badge')) {
                const topicText = e.target.textContent.trim();
                // Simple logic: If subject is empty, add topic. Else, append.
                if (!emailSubjectInput.value.trim()) {
                    emailSubjectInput.value = topicText;
                } else if (!emailSubjectInput.value.includes(topicText)) {
                     emailSubjectInput.value += ` - ${topicText}`;
                }
                // Maybe add to body too? Or provide a simple template?
                // For now, just update subject.
                emailSubjectInput.focus(); // Focus subject field
                updateSendButtonState();
            }
        });
    }

  // Use Template Button (Placeholder)
  if (templateBtn) {
    templateBtn.addEventListener('click', () => {
        if (!currentMP) {
            showToast("Please find your MP first.", "info");
            return;
        }
        const mpLastName = currentMP.nameDisplayAs.split(' ').pop();
        const constituencyName = currentMP.latestHouseMembership?.membershipFrom || 'my constituency';

        const templateSubject = `Regarding [Your Topic] in ${constituencyName}`;
        const templateBody = `Dear Mr/Ms/Dr ${mpLastName},\n\n` +
                             `I am writing to you as a constituent in ${constituencyName} regarding [Your Topic].\n\n` +
                             `[Explain briefly why this issue is important to you. Share your personal story or experience if relevant. Be specific about the problem.]\n\n` +
                             `[State clearly what action you would like your MP to take. E.g., "I urge you to support the upcoming bill...", "Could you please ask a question in Parliament about...", "Would you be able to meet with me/a constituent group..."]\n\n` +
                             `Thank you for your time and consideration of this important matter.\n\n` +
                             `Yours sincerely,\n\n` +
                             `[Your Full Name]\n[Your Full Address & Postcode]`;

        emailSubjectInput.value = templateSubject;
        emailBodyTextarea.value = templateBody;
        updateCharCount(); // Update count after filling template
        updateSendButtonState();
        showToast("Template loaded into message body.", "info");
    });
  }

  // Form Validation (using Bootstrap's built-in validation)
  if (draftForm) {
      draftForm.addEventListener('input', updateSendButtonState); // Check validity on input
      privacyConsentCheckbox.addEventListener('change', updateSendButtonState); // Check validity when privacy consent changes

      // Prevent default form submission for now, handle via preview/send buttons
      draftForm.addEventListener('submit', function(event) {
          event.preventDefault();
          event.stopPropagation();

          if (!currentMP) {
             showToast("Please find your MP before sending.", "warning");
             if (mpWarning) mpWarning.classList.remove('d-none');
             return;
          }

          if (draftForm.checkValidity() === false || emailBodyTextarea.value.length > maxCharCount) {
              showToast("Please fill out all required fields and check message length.", "warning");
              draftForm.classList.add('was-validated'); // Show validation feedback
              return;
          }

          // If validation passes, proceed to Preview (or direct send if no preview)
          // This structure implies preview is required before sending.
          // If you want direct send, move the sending logic here.
          // As per HTML structure, we go to preview first.
          populatePreviewModal();
          previewModal.show();
      });
  }


  // Populate & Show Preview Modal
  if (previewBtn) {
      previewBtn.addEventListener('click', () => {
           if (!currentMP) {
              showToast("Please find your MP first.", "info");
              return;
           }
           if (draftForm.checkValidity() === false || emailBodyTextarea.value.length > maxCharCount) {
              showToast("Please fill out all required fields and check message length.", "warning");
              draftForm.classList.add('was-validated');
              return;
          }
          populatePreviewModal();
          previewModal.show();
      });
  }

  function populatePreviewModal() {
      if (!currentMP || !previewToSpan || !previewFromSpan || !previewSubjectSpan || !previewBodyDiv || !previewSignatureDiv) return;

      const mpEmailAddress = mpEmail.textContent.trim();
      const userName = fullNameInput.value.trim();
      const userEmail = userEmailInput.value.trim();
      const userAddress = userAddressInput.value.trim().replace(/\n/g, '<br>'); // Format address for display
      const subject = emailSubjectInput.value.trim();
      const body = emailBodyTextarea.value.trim().replace(/\n/g, '<br>'); // Format body for display

      previewToSpan.textContent = `${currentMP.nameDisplayAs || 'Your MP'} <${mpEmailAddress}>`;
      previewFromSpan.textContent = `${userName} <${userEmail}>`;
      previewSubjectSpan.textContent = subject;
      previewBodyDiv.innerHTML = body;
      previewSignatureDiv.innerHTML = `${userName}<br>${userAddress}`; // Signature includes name and address

      // Enable send button in modal
      previewSendBtn.disabled = !mpEmailAddress || !userName || !userEmail || !subject || !body;
  }


  // Send Message Button (Modal)
  if (previewSendBtn) {
      previewSendBtn.addEventListener('click', () => {
          // In a real application, you would send this data to your backend
          // which would then send the email. Using mailto: is not reliable
          // for sensitive data or message length. This is a placeholder.

          if (!currentMP || !mpEmail.textContent.trim()) {
              showToast("Error: MP email not found.", "danger");
              previewModal.hide();
              return;
          }

          const mpEmailAddress = mpEmail.textContent.trim();
          const userName = fullNameInput.value.trim();
          const userEmail = userEmailInput.value.trim(); // Included in 'From' via backend ideally
          const userAddress = userAddressInput.value.trim();
          const subject = emailSubjectInput.value.trim();
          const body = emailBodyTextarea.value.trim();
          const copyMe = copyMeCheckbox.checked;

          // Prepare data to send to backend
          const messageData = {
              mpId: currentMP.id,
              mpEmail: mpEmailAddress,
              fullName: userName,
              email: userEmail,
              address: userAddress,
              subject: subject,
              body: body,
              sendCopy: copyMe
          };

          showLoadingOverlay(); // Show loading while sending (simulated)
          previewSendBtn.disabled = true; // Prevent double-click

          // --- Simulate Sending ---
          setTimeout(() => {
              hideLoadingOverlay();
              previewModal.hide();
              successModal.show(); // Show success modal

              // In a real app, replace this with a fetch() call to your backend
              // fetch('/api/send-message', {
              //     method: 'POST',
              //     headers: { 'Content-Type': 'application/json' },
              //     body: JSON.stringify(messageData)
              // })
              // .then(response => {
              //     if (!response.ok) throw new Error('Failed to send message via API');
              //     return response.json(); // Or response.text()
              // })
              // .then(data => {
              //     hideLoadingOverlay();
              //     previewModal.hide();
              //     successModal.show();
              //     updateProgress(3); // Move to Review/Sent step
              //     // Optionally reset form here or on success modal close
              // })
              // .catch(error => {
              //     console.error('Error sending message:', error);
              //     hideLoadingOverlay();
              //     showToast('Failed to send message. Please try again.', 'danger');
              //     previewSendBtn.disabled = false; // Re-enable send button in modal
              // });

              updateProgress(3); // Move to Review/Sent step (assuming success simulation)

          }, 1500); // Simulate network delay
          // --- End Simulation ---
      });
  }

    // Success Modal Buttons
    if (writeAnotherBtn) {
        writeAnotherBtn.addEventListener('click', () => {
            resetForm(); // Reset the form for a new message
            successModal.hide();
        });
    }
    if (shareFeedbackBtn) {
        shareFeedbackBtn.addEventListener('click', () => {
            // Placeholder for feedback link/modal
            alert("Share Feedback button clicked!"); // Replace with actual feedback mechanism
        });
    }


  // --- Settings Dropdown ---

  // High Contrast Mode
  if (contrastBtn) {
      contrastBtn.addEventListener('click', () => {
          document.body.classList.toggle('contrast');
          // Persist setting in localStorage
          if (document.body.classList.contains('contrast')) {
              localStorage.setItem('contrastMode', 'enabled');
          } else {
              localStorage.removeItem('contrastMode');
          }
      });
      // Apply contrast mode on load if saved
      if (localStorage.getItem('contrastMode') === 'enabled') {
          document.body.classList.add('contrast');
      }
  }

  // Larger Text
  if (fontSizeBtn) {
      fontSizeBtn.addEventListener('click', () => {
          document.body.classList.toggle('larger-text');
          // You would define styles for `.larger-text` in your CSS
          // e.g., body.larger-text { font-size: 1.1rem; }
          // Then adjust other font sizes relative to this.
           // Persist setting in localStorage (Optional)
          if (document.body.classList.contains('larger-text')) {
              localStorage.setItem('largerText', 'enabled');
          } else {
              localStorage.removeItem('largerText');
          }
      });
       // Apply larger text on load if saved
      if (localStorage.getItem('largerText') === 'enabled') {
          document.body.classList.add('larger-text');
      }
  }

  // Reset Form
  if (resetBtn) {
      resetBtn.addEventListener('click', resetForm);
  }


    // --- Tooltips Initialization ---
    // Initialize all tooltips on the page
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));

    // --- Initial State Setup ---
    showMPCard(false); // Start with placeholder visible
    updateProgress(1); // Start at step 1
    updateSendButtonState(); // Disable send button initially

  // Validate postcode before search
  if (findBtn) {
    findBtn.addEventListener('click', () => {
      const postcode = postcodeInput.value.trim();
      validateAndFindMP(postcode);
    });
  }

  if (postcodeInput) {
    postcodeInput.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        const postcode = postcodeInput.value.trim();
        validateAndFindMP(postcode);
      }
    });
  }

  // Function to validate postcode and then find MP
  async function validateAndFindMP(postcode) {
    if (!postcode) {
      constituencyLabel.textContent = 'Please enter a postcode.';
      return;
    }
    
    // Show loading state
    showLoadingOverlay();
    constituencyLabel.textContent = 'Validating postcode...';
    
    try {
      // First validate the postcode with postcodes.io
      const validateUrl = `https://api.postcodes.io/postcodes/${encodeURIComponent(postcode)}/validate`;
      const validateResponse = await fetch(validateUrl);
      const validateData = await validateResponse.json();
      
      if (validateData.status === 200 && validateData.result) {
        // Valid postcode, proceed to find MP
        constituencyLabel.textContent = 'Looking up MP...';
        findMP(postcode);
      } else {
        // Invalid postcode
        hideLoadingOverlay();
        constituencyLabel.textContent = '';
        postcodeError.textContent = 'Please enter a valid UK postcode';
        postcodeError.className = 'd-block mt-1 text-warning fw-medium';
        showMPCard(false);
      }
    } catch (error) {
      console.error('Error validating postcode:', error);
      hideLoadingOverlay();
      constituencyLabel.textContent = 'Error validating postcode. Please try again.';
      showMPCard(false);
    }
  }

  // Initialize Mapbox Address Autofill
  if (findAddressBtn && addressAutofillContainer) {
    // Initialize Mapbox Search 
    let autofill;
    let minimap;
    let retrievedFeature;

    // Show the address autofill UI when the button is clicked
    findAddressBtn.addEventListener('click', function() {
      const postcode = postcodeInput.value.trim();
      
      if (!postcode) {
        showToast('Please enter a postcode first', 'warning');
        postcodeInput.focus();
        return;
      }
      
      showAddressAutofill(postcode);
    });

    function showAddressAutofill(initialPostcode) {
      // Initialize Mapbox address autofill if not already done
      if (!autofill) {
        // Create the address autofill instance
        autofill = new MapboxAddressAutofill({
          accessToken: mapboxToken,
          theme: {
            variables: {
              fontFamily: 'Inter, sans-serif',
              borderRadius: '0.5rem',
              padding: '0.75rem 1rem',
              width: '100%'
            }
          }
        });

        // Create minimap
        minimap = new MapboxAddressMinimap({
          accessToken: mapboxToken,
          canAdjustMarker: true,
          satelliteToggle: true
        });

        // Handle address selection
        autofill.addEventListener('retrieve', (e) => {
          console.log('Address selected:', e.detail);
          retrievedFeature = e.detail.features[0];
          
          if (retrievedFeature) {
            // Show the minimap with the selected location
            minimap.feature = retrievedFeature;
            minimap.show = true;
            minimapContainer.classList.remove('d-none');
            
            // Format the address for the textarea
            formatAddressFromFeature(retrievedFeature);
            
            addressLookupStatus.textContent = 'Address selected!';
            addressLookupStatus.className = 'form-text mt-1 text-success';
          }
        });
      }

      // Set the initial search value to the postcode if provided
      if (initialPostcode) {
        autofill.setValue(initialPostcode);
      }

      // Render the autofill component
      autofill.render({ container: addressAutofillContainer });
      
      // Show the container
      addressLookupContainer.classList.remove('d-none');
      
      // Add status message
      addressLookupStatus.textContent = 'Start typing an address to see suggestions';
      addressLookupStatus.className = 'form-text mt-1 text-muted';
    }

    function formatAddressFromFeature(feature) {
      if (!feature) return;
      
      // Format the full address from the feature
      const placeName = feature.place_name;
      const addressLines = placeName.split(',').map(line => line.trim());
      
      // Format the address for the textarea
      userAddressInput.value = addressLines.join('\n');
    }
  }

  // Initialize Mapbox address lookup
  if (findAddressBtn && addressLookupContainer) {
    // Show the address lookup when the button is clicked
    findAddressBtn.addEventListener('click', function() {
      const postcode = postcodeInput.value.trim();
      
      if (!postcode) {
        showToast('Please enter a postcode first', 'warning');
        postcodeInput.focus();
        return;
      }

      // Show loading state
      addressLookupStatus.textContent = 'Validating postcode...';
      addressLookupStatus.className = 'form-text mt-1 text-muted';
      
      // First validate the postcode with postcodes.io
      fetch(`https://api.postcodes.io/postcodes/${encodeURIComponent(postcode)}/validate`)
        .then(response => response.json())
        .then(data => {
          if (data.status === 200 && data.result) {
            // Valid postcode, get postcode details
            addressLookupStatus.textContent = 'Retrieving address information...';
            return fetch(`https://api.postcodes.io/postcodes/${encodeURIComponent(postcode)}`);
          } else {
            throw new Error('Invalid postcode');
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.status === 200 && data.result) {
            const postcodeData = data.result;
            showAddressForm(postcodeData);
          } else {
            throw new Error('Could not retrieve postcode data');
          }
        })
        .catch(error => {
          console.error('Error processing postcode:', error);
          addressLookupStatus.textContent = 'Error: ' + (error.message || 'Could not process postcode. Please enter your address manually.');
          addressLookupStatus.className = 'form-text mt-1 text-danger';
          showSimpleAddressForm(postcode);
        });
    });

    // Function to show a pre-filled address form based on postcode data
    function showAddressForm(postcodeData) {
      // Show the container
      addressLookupContainer.classList.remove('d-none');
      
      // Create a textarea for manual entry
      const geocoderContainer = document.getElementById('geocoder-container');
      geocoderContainer.innerHTML = '';
      
      // Create structured address entry with multiple fields
      const addressForm = document.createElement('div');
      addressForm.className = 'address-form';
      
      // House number/name field
      const houseField = document.createElement('div');
      houseField.className = 'mb-2';
      const houseLabel = document.createElement('label');
      houseLabel.textContent = 'House/Building Number or Name';
      houseLabel.className = 'form-label';
      const houseInput = document.createElement('input');
      houseInput.type = 'text';
      houseInput.className = 'form-control';
      houseInput.placeholder = 'e.g. 42 or Willow House';
      houseField.appendChild(houseLabel);
      houseField.appendChild(houseInput);
      addressForm.appendChild(houseField);
      
      // Street field
      const streetField = document.createElement('div');
      streetField.className = 'mb-2';
      const streetLabel = document.createElement('label');
      streetLabel.textContent = 'Street';
      streetLabel.className = 'form-label';
      const streetInput = document.createElement('input');
      streetInput.type = 'text';
      streetInput.className = 'form-control';
      streetInput.placeholder = 'e.g. High Street';
      streetField.appendChild(streetLabel);
      streetField.appendChild(streetInput);
      addressForm.appendChild(streetField);
      
      // Create remaining address info (pre-filled)
      const addressInfo = document.createElement('div');
      addressInfo.className = 'mb-3 mt-3';
      
      // Format remaining address parts
      const addressParts = [];
      if (postcodeData.parish && !['Unparished Area', 'null', 'undefined'].includes(postcodeData.parish)) {
        addressParts.push(postcodeData.parish);
      }
      if (postcodeData.admin_ward) {
        addressParts.push(postcodeData.admin_ward);
      }
      if (postcodeData.admin_district) {
        addressParts.push(postcodeData.admin_district);
      }
      if (postcodeData.admin_county) {
        addressParts.push(postcodeData.admin_county);
      }
      addressParts.push(postcodeData.postcode);
      
      const addressText = addressParts.join('\n');
      
      const addressDisplay = document.createElement('div');
      addressDisplay.className = 'card p-3 bg-light';
      addressDisplay.innerHTML = `
        <small class="text-muted">The following will be added to your address:</small>
        <div class="mt-2 mb-2" style="white-space: pre-line;">${addressText}</div>
      `;
      
      addressInfo.appendChild(addressDisplay);
      addressForm.appendChild(addressInfo);
      
      // Add a button to apply address
      const applyBtn = document.createElement('button');
      applyBtn.type = 'button';
      applyBtn.className = 'btn btn-primary';
      applyBtn.textContent = 'Use This Address';
      addressForm.appendChild(applyBtn);
      
      // Add the form to the container
      geocoderContainer.appendChild(addressForm);
      
      // Listen for button click to apply address
      applyBtn.addEventListener('click', function() {
        const houseValue = houseInput.value.trim();
        const streetValue = streetInput.value.trim();
        
        if (!houseValue || !streetValue) {
          showToast('Please enter both house/building details and street', 'warning');
          return;
        }
        
        // Format the complete address
        const fullAddress = [
          houseValue,
          streetValue,
          ...addressParts
        ].join('\n');
        
        // Update the address field
        userAddressInput.value = fullAddress;
        
        addressLookupStatus.textContent = 'Address applied!';
        addressLookupStatus.className = 'form-text mt-1 text-success';
      });
      
      // Success message
      addressLookupStatus.textContent = 'Please enter your house/building details and street';
      addressLookupStatus.className = 'form-text mt-1 text-info';
    }
    
    // Fallback for manual entry
    function showSimpleAddressForm(postcode) {
      // Show the container
      addressLookupContainer.classList.remove('d-none');
      
      // Create a simple textarea for manual entry
      const geocoderContainer = document.getElementById('geocoder-container');
      geocoderContainer.innerHTML = '';
      
      const formGroup = document.createElement('div');
      formGroup.className = 'form-group';
      
      const label = document.createElement('label');
      label.textContent = 'Enter your full address';
      label.className = 'form-label';
      formGroup.appendChild(label);
      
      const textarea = document.createElement('textarea');
      textarea.className = 'form-control';
      textarea.rows = 5;
      textarea.placeholder = 'House/Building number and name\nStreet\nTown/City\nPostcode';
      
      // Pre-fill with postcode if available
      if (postcode) {
        textarea.value = postcode;
      }
      
      formGroup.appendChild(textarea);
      
      // Add a button to apply address
      const applyBtn = document.createElement('button');
      applyBtn.type = 'button';
      applyBtn.className = 'btn btn-primary mt-2';
      applyBtn.textContent = 'Use This Address';
      formGroup.appendChild(applyBtn);
      
      geocoderContainer.appendChild(formGroup);
      
      // Listen for changes
      textarea.addEventListener('input', function() {
        userAddressInput.value = this.value;
      });
      
      // Listen for button click to apply address
      applyBtn.addEventListener('click', function() {
        userAddressInput.value = textarea.value;
        addressLookupStatus.textContent = 'Address applied!';
        addressLookupStatus.className = 'form-text mt-1 text-success';
      });
    }
  }

  // Initialize address lookup with Mapbox GL JS
  if (findAddressBtn && addressLookupContainer) {
    const mapboxToken = 'pk.eyJ1IjoibXVhemFtc2FyZmFyYXoiLCJhIjoiY205b2dzdnVlMTVuZDJqczcwbnBseW1tYiJ9.-MvfX63GtzUQceap1g6iJQ';
    let map;
    let marker;
    
    // Show the address lookup when the button is clicked
    findAddressBtn.addEventListener('click', function() {
      const postcode = postcodeInput.value.trim();
      
      if (!postcode) {
        showToast('Please enter a postcode first', 'warning');
        postcodeInput.focus();
        return;
      }

      // Show loading state
      addressLookupStatus.textContent = 'Looking up postcode location...';
      addressLookupStatus.className = 'form-text mt-1 text-muted';
      addressLookupContainer.classList.remove('d-none');
      
      // Create search UI and map container
      const container = document.getElementById('address-autofill-container');
      container.innerHTML = `
        <div class="mb-3">
          <label class="form-label">Enter your full address</label>
          <input type="text" id="address-search" class="form-control" placeholder="Start typing your address...">
        </div>
        <div id="suggestions-container"></div>
      `;
      
      // Initialize the map container
      const mapContainer = document.getElementById('minimap-container');
      mapContainer.classList.remove('d-none');
      
      // Initialize map if not already created
      if (!map) {
        mapboxgl.accessToken = mapboxToken;
        map = new mapboxgl.Map({
          container: 'minimap-container',
          style: 'mapbox://styles/mapbox/streets-v12',
          center: [-1.78, 52.47], // Roughly center of UK
          zoom: 5,
          interactive: true
        });
        
        // Add navigation controls
        map.addControl(new mapboxgl.NavigationControl(), 'top-right');
      }
      
      // First geocode the postcode to center the map
      fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(postcode)}.json?access_token=${mapboxToken}&country=gb&types=postcode`)
        .then(response => response.json())
        .then(data => {
          if (data.features && data.features.length > 0) {
            const feature = data.features[0];
            const center = feature.center;
            
            // Center the map on the postcode
            map.flyTo({
              center: center,
              zoom: 15
            });
            
            // Add a marker
            if (marker) marker.remove();
            marker = new mapboxgl.Marker({
              color: '#1e40af',
              draggable: true
            })
              .setLngLat(center)
              .addTo(map);
            
            // Update status
            addressLookupStatus.textContent = 'Type your street and house number above';
            addressLookupStatus.className = 'form-text mt-1 text-info';
            
            // Create address form from postcode data
            createAddressFormFromPostcode(postcode);
            
            // Set up the address search functionality
            setupAddressSearch(postcode);
          } else {
            // Postcode not found
            addressLookupStatus.textContent = 'Postcode not found. Please enter your address manually.';
            addressLookupStatus.className = 'form-text mt-1 text-warning';
            
            // Show manual address form
            showManualAddressForm(postcode);
          }
        })
        .catch(error => {
          console.error('Error geocoding postcode:', error);
          addressLookupStatus.textContent = 'Error looking up postcode. Please enter your address manually.';
          addressLookupStatus.className = 'form-text mt-1 text-danger';
          
          // Show manual address form
          showManualAddressForm(postcode);
        });
    });
    
    // Function to set up address search with suggestions
    function setupAddressSearch(postcode) {
      const searchInput = document.getElementById('address-search');
      const suggestionsContainer = document.getElementById('suggestions-container');
      
      if (!searchInput) return;
      
      // Set initial focus
      searchInput.focus();
      
      // Add event listener for input changes
      let debounceTimeout;
      searchInput.addEventListener('input', function() {
        clearTimeout(debounceTimeout);
        
        const query = this.value.trim();
        if (query.length < 3) {
          suggestionsContainer.innerHTML = '';
          return;
        }
        
        // Debounce the search to avoid too many API calls
        debounceTimeout = setTimeout(() => {
          // Combine the search query with the postcode for better results
          const searchQuery = `${query} ${postcode}`;
          
          // Search for addresses
          fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(searchQuery)}.json?access_token=${mapboxToken}&country=gb&types=address&proximity=${marker.getLngLat().lng},${marker.getLngLat().lat}`)
            .then(response => response.json())
            .then(data => {
              // Clear previous suggestions
              suggestionsContainer.innerHTML = '';
              
              if (data.features && data.features.length > 0) {
                // Create suggestions list
                const suggestionsList = document.createElement('div');
                suggestionsList.className = 'list-group mt-2 mb-3';
                
                // Add each suggestion
                data.features.forEach(feature => {
                  const item = document.createElement('button');
                  item.type = 'button';
                  item.className = 'list-group-item list-group-item-action';
                  item.textContent = feature.place_name;
                  
                  // Add click handler to select this address
                  item.addEventListener('click', () => {
                    // Update the input value
                    searchInput.value = feature.place_name;
                    
                    // Clear suggestions
                    suggestionsContainer.innerHTML = '';
                    
                    // Update marker position
                    marker.setLngLat(feature.center);
                    
                    // Fly to the location
                    map.flyTo({
                      center: feature.center,
                      zoom: 17
                    });
                    
                    // Format the address for the textarea
                    formatAddressFromFeature(feature);
                    
                    // Update status
                    addressLookupStatus.textContent = 'Address selected!';
                    addressLookupStatus.className = 'form-text mt-1 text-success';
                  });
                  
                  suggestionsList.appendChild(item);
                });
                
                suggestionsContainer.appendChild(suggestionsList);
              } else {
                suggestionsContainer.innerHTML = '<div class="alert alert-info">No matches found. Try a different search or enter your address manually.</div>';
              }
            })
            .catch(error => {
              console.error('Error searching for addresses:', error);
              suggestionsContainer.innerHTML = '<div class="alert alert-danger">Error searching for addresses. Please try again.</div>';
            });
        }, 300);
      });
    }
    
    // Function to create address form from postcode data
    function createAddressFormFromPostcode(postcode) {
      // Get postcode details from postcodes.io
      fetch(`https://api.postcodes.io/postcodes/${encodeURIComponent(postcode)}`)
        .then(response => response.json())
        .then(data => {
          if (data.status === 200 && data.result) {
            const postcodeData = data.result;
            
            // Store postcode data for later use
            const postcodeInfo = {
              postcode: postcodeData.postcode,
              district: postcodeData.admin_district || '',
              ward: postcodeData.admin_ward || '',
              parish: postcodeData.parish || '',
              county: postcodeData.admin_county || ''
            };
            
            // Store in data attribute on container for use when formatting address
            document.getElementById('address-autofill-container').dataset.postcodeInfo = JSON.stringify(postcodeInfo);
          }
        })
        .catch(error => {
          console.error('Error fetching postcode details:', error);
        });
    }
    
    // Function to format address from Mapbox feature
    function formatAddressFromFeature(feature) {
      if (!feature) return;
      
      // Try to get stored postcode info
      let postcodeInfo = {};
      try {
        const infoString = document.getElementById('address-autofill-container').dataset.postcodeInfo;
        if (infoString) {
          postcodeInfo = JSON.parse(infoString);
        }
      } catch (e) {
        console.error('Error parsing postcode info:', e);
      }
      
      // Get the main address part (first line in the place_name)
      const placeParts = feature.place_name.split(',').map(part => part.trim());
      
      // Build address parts
      const addressParts = [];
      
      // First line is typically house number + street
      if (placeParts.length > 0) {
        addressParts.push(placeParts[0]);
      }
      
      // Add district/locality if available and not already in the first line
      if (placeParts.length > 1 && !placeParts[0].includes(placeParts[1])) {
        addressParts.push(placeParts[1]);
      }
      
      // Add postcode information
      if (postcodeInfo.district) {
        addressParts.push(postcodeInfo.district);
      }
      
      if (postcodeInfo.county && postcodeInfo.county !== postcodeInfo.district) {
        addressParts.push(postcodeInfo.county);
      }
      
      // Add postcode
      if (postcodeInfo.postcode) {
        addressParts.push(postcodeInfo.postcode);
      } else if (postcodeInput.value) {
        addressParts.push(postcodeInput.value.trim().toUpperCase());
      }
      
      // Set the address in the textarea
      userAddressInput.value = addressParts.join('\n');
    }
    
    // Function to show manual address form
    function showManualAddressForm(postcode) {
      const container = document.getElementById('address-autofill-container');
      container.innerHTML = `
        <div class="form-group">
          <label class="form-label">Enter your full address</label>
          <textarea id="manual-address" class="form-control" rows="5" 
                   placeholder="House/Building number and name&#10;Street&#10;Town/City&#10;Postcode">${postcode}</textarea>
          <button type="button" class="btn btn-primary mt-2" id="apply-manual-address">Use This Address</button>
        </div>
      `;
      
      // Hide map
      document.getElementById('minimap-container').classList.add('d-none');
      
      // Listen for changes on the manual textarea
      const manualAddress = document.getElementById('manual-address');
      if (manualAddress) {
        manualAddress.addEventListener('input', function() {
          userAddressInput.value = this.value;
        });
        
        // Add button click handler
        const applyBtn = document.getElementById('apply-manual-address');
        if (applyBtn) {
          applyBtn.addEventListener('click', function() {
            userAddressInput.value = manualAddress.value;
            addressLookupStatus.textContent = 'Address applied!';
            addressLookupStatus.className = 'form-text mt-1 text-success';
          });
        }
      }
    }
  }
});
</script>
</body>
</html>